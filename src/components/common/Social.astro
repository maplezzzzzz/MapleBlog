---
import type { SocialLinks } from "@/types";
import { SiXiaohongshu } from "react-icons/si";
import {
  FaEnvelope,
  FaGithub,
  FaInstagram,
  FaGlobe,
  FaWeixin,
} from "react-icons/fa";
import GlassButton from "@components/ui/GlassButton.astro";

interface Props {
  links?: SocialLinks;
}

const { links } = Astro.props;

const liClass = "inline-block px-1 intersect:animate-fade opacity-0";
const iconClass =
  "glass-l hover:glass rounded text-txt-light dark:text-darkmode-txt-p flex h-9 w-9 items-center justify-center text-center transition duration-300";
---

{
  links && (
    <ul class="py-2 flex items-center">
      {links.wechat && (
        <li class={`${liClass}`}>
          <a id="wechat-popup-trigger" href="javascript:void(0);" data-wechat-value={links.wechat}>
            <GlassButton
              id="wechatIcon"
              variant="info"
              size="sm"
              iconPosition="left"
              title="微信"
              className="min-w-10 justify-center"
            >
              <span class="sr-only">公众号</span>
              <FaWeixin className="w-6 h-6 dark:hover:text-green-600 hover:text-green-600 transition duration-300" />
            </GlassButton>
          </a>
        </li>
      )}
      {links.xhs && (
        <li class={liClass}>
          <a href={links.xhs}>
            <GlassButton
              id="xhs"
              variant="info"
              size="sm"
              iconPosition="left"
              title="小红书"
              className="min-w-10 justify-center"
            >
              <span class="sr-only">小红书</span>
              <SiXiaohongshu className="w-6 h-6  dark:hover:text-red-600 hover:text-red-600 transition duration-300" />
            </GlassButton>
          </a>
        </li>
      )}
      {links.email && (
        <li class={liClass}>
          <a href={`mailto:${links.email}`}>
            <GlassButton
              id="email"
              variant="info"
              size="sm"
              iconPosition="left"
              title="Email"
              className="min-w-10 justify-center"
            >
              <span class="sr-only">Email</span>
              <FaEnvelope className="w-6 h-6  dark:hover:text-yellow-200 hover:text-yellow-200 transition duration-300" />
            </GlassButton>
          </a>
        </li>
      )}
      {links.github && (
        <li class={liClass}>
          <a href={links.github}>
            <GlassButton
              id="github"
              variant="info"
              size="sm"
              iconPosition="left"
              title="GitHub"
              className="min-w-10 justify-center"
            >
              <span class="sr-only">GitHub</span>
              <FaGithub className="w-6 h-6  dark:hover:text-black hover:text-black transition duration-300" />
            </GlassButton>
          </a>
        </li>
      )}
    </ul>
  )
}

<script>
  import { showToast } from "@lib/toastUtils.ts";

  let tooltipEl: HTMLElement | null = null;

  function createTooltip(imageUrl: string) {
    const div = document.createElement('div');
    div.className = 'fixed z-[9999] p-2 bg-white dark:bg-gray-800 rounded-lg shadow-xl transition-opacity duration-200 opacity-0 pointer-events-none';
    div.innerHTML = `<img src="${imageUrl}" alt="二维码" class="w-32 h-32 object-cover rounded block">`;
    document.body.appendChild(div);
    return div;
  }

  function setupWechatPopup() {
    const wechatTrigger = document.getElementById("wechat-popup-trigger");
    if (!wechatTrigger) {
        console.log("Social: WeChat trigger not found");
        return;
    }

    const wechatValue = wechatTrigger.getAttribute("data-wechat-value");
    console.log("Social: WeChat Value =", wechatValue);
    
    if (!wechatValue) return;

    const isImage = wechatValue.match(/\.(jpeg|jpg|gif|png|webp)$/i) || wechatValue.startsWith('/assets/') || wechatValue.startsWith('/uploads/') || wechatValue.startsWith('http');
    console.log("Social: Is Image?", isImage);

    // 悬停逻辑
    if (isImage) {
        wechatTrigger.addEventListener('mouseenter', () => {
            console.log("Social: Mouse enter");
            if (!tooltipEl) tooltipEl = createTooltip(wechatValue);
            
            const rect = wechatTrigger.getBoundingClientRect();
            // ...
            
            // 计算位置：图标正上方，水平居中
            const top = rect.top - 140; // 预留高度
            const left = rect.left + (rect.width / 2) - (128 / 2) - 8; // 128 is w-32

            tooltipEl.style.top = `${top}px`;
            tooltipEl.style.left = `${left}px`;
            
            // 显示动画
            requestAnimationFrame(() => {
                if(tooltipEl) tooltipEl.classList.remove('opacity-0');
            });
        });

        wechatTrigger.addEventListener('mouseleave', () => {
            console.log("Social: Mouse leave");
            if (tooltipEl) {
                tooltipEl.classList.add('opacity-0');
                // 延迟移除或复用
                setTimeout(() => {
                    if (tooltipEl && tooltipEl.classList.contains('opacity-0')) {
                        tooltipEl.remove();
                        tooltipEl = null;
                    }
                }, 200);
            }
        });
    }

    // 点击逻辑 (移动端兼容)
    wechatTrigger.addEventListener("click", (e) => {
        e.preventDefault();
        console.log("Social: Clicked. Is Image?", isImage);
        
        if (isImage) {
            showToast({
              title: "微信二维码",
              content: `<div class="flex justify-center"><img src="${wechatValue}" alt="微信二维码" class="max-w-[200px] h-auto rounded-lg shadow-md"></div>`,
              type: 'info',
              duration: 0, 
              closable: true,
              position: 'top-center'
            });
        } else {
            navigator.clipboard.writeText(wechatValue).then(() => {
                showToast({ title: "已复制", message: `微信号 "${wechatValue}" 已复制`, type: "success" });
            });
        }
    });
  }

  // 立即尝试初始化
  setupWechatPopup();
  
  // 绑定 Astro 页面切换事件
  document.addEventListener("astro:page-load", setupWechatPopup);
</script>

