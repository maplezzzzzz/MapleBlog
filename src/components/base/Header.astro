---
import ThemeSwitcher from "@components/base/ThemeSwitcher.astro";
import { IoSearch } from "react-icons/io5";
import logoImage from "@assets/image/logo.png";
import LiquidGlass from "@components/common/LiquidGlassLess.astro";
import GlassButton from "@components/ui/GlassButton.astro";
import { SITE_INFO } from "@lib/config";
import { getSiteSettings } from "@/utils/settings";
import { getSiteMenus } from "@/utils/menus";
import { Image } from "astro:assets";

const { pathname } = Astro.url;
const dynamicSettings = getSiteSettings();
const siteMenus = getSiteMenus();

const stickyHeader = true;

// 获取网站基本信息
let siteName = dynamicSettings.site.title || SITE_INFO?.SITE_NAME || ""; 
let siteLogoUrl = SITE_INFO?.LOGO_IMAGE || logoImage.src || "";

// 使用动态菜单数据，如果有的话
const menu = siteMenus.header.length > 0 ? siteMenus.header : [
  {
    name: "首页",
    url: "/",
    children: [],
  },
  {
    name: "博客",
    url: "/blog",
    children: [],
  },
  {
    name: "关于",
    url: "/about",
    children: [],
  },
];
---

<header
  transition:persist
  class={`container px-3 lg:px-8 pb-6 z-30 lg:mt-4 lg:rounded-full ${stickyHeader && "sticky top-0"}`}
>
  <LiquidGlass
    enableGlassEffect
    containerType="nav"
    wrapperClass="p-2.5 rounded-[35px] relative hover:bg-white/30 dark:bg-black/20 dark:hover:bg-black/50 !transition-colors duration-500 !delay-300"
    textClass="min-h-12 md:min-h-14 flex flex-wrap items-center justify-start"
    effectClass="rounded-[35px]"
    tintClass="rounded-[35px]"
    shineClass="rounded-[35px]"
    animation="fadeDown"
  >
    <!-- 网站名称 -->
    <div class="order-0 flex ml-4 items-center">
      <a href="/" class="flex items-center">
        {
          siteLogoUrl && (
            <Image
              src={siteLogoUrl}
              alt={siteName}
              class="w-8 h-8 mx-1 rounded-full"
              width={32}
              height={32}
              eagerly-loaded={true}
            />
          )
        }

        {
          siteName && (
            <span class="text-xl font-bold justify-center text-txt-p dark:text-darkmode-txt-p">
              {siteName}
            </span>
          )
        }
      </a>
    </div>

    <!-- navbar toggler -->
    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      for="nav-toggle"
      class="order-2 cursor-pointer flex items-center md:hidden text-txt-p dark:text-darkmode-txt-p lg:order-1"
    >
      <svg
        id="show-button"
        class="h-5 mx-2 fill-current block"
        viewBox="0 0 20 20"
      >
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
      <svg
        id="hide-button"
        class="h-5 mx-2 fill-current hidden"
        viewBox="0 0 20 20"
      >
        <title>Menu Close</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>
    <!-- /navbar toggler -->
    <ul
      id="nav-menu"
      class="bg-slate-100/90 md:bg-inherit rounded-lg text-center relative ml-8 order-3 hidden w-full p-4 md:order-1 md:flex md:w-auto md:gap-1 md:p-0 lg:text-left lg:gap-2"
    >
      {
        menu.map((item: any) => (
          <li class="relative dropdown group">
            <a
              href={item.url}
              target={item.target || "_self"}
              class={`flex items-center justify-center h-full my-4 md:my-0 border-none gap-2 px-4 py-2 font-bold text-txt-p transition-all duration-300 dark:text-darkmode-txt-p rounded-full z-10 text-lg 
                group-hover:text-orange-500
                ${
                  (item.url === '/' ? pathname === '/' : pathname.startsWith(item.url)) ||
                  (item.children && item.children.some((child: any) => child.url !== '/' && pathname.startsWith(child.url)))
                    ? "text-orange-500"
                    : ""
                }`}
            >
              <span
                class={`absolute inset-0 rounded-full transition-all duration-300 
                  group-hover:bg-white/30 group-hover:dark:bg-white/10 group-hover:backdrop-blur-sm
                  ${
                    (item.url === '/' ? pathname === '/' : pathname.startsWith(item.url)) ||
                    (item.children && item.children.some((child: any) => child.url !== '/' && pathname.startsWith(child.url)))
                      ? "bg-white/30 dark:bg-white/10 backdrop-blur-sm"
                      : ""
                  }`}
              >
              </span>
              <span class="relative">
                {item.icon && <span class="text-sm">{item.icon}</span>}
                {item.name}
              </span>
            </a>

            {/* 下拉菜单 */}
            {item.children && item.children.length > 0 && (
              <ul class="submenu absolute top-full left-1/2 -translate-x-1/2 w-max bg-white/30 dark:bg-white/10 backdrop-blur-xl border border-white/20 dark:border-white/10 rounded-full shadow-2xl z-50 p-2 mt-3 invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-200 flex flex-row gap-1">
                {item.children.map((child: any) => (
                  <li class="group">
                    <a
                      href={child.url}
                      target={child.target || "_self"}
                      class={`flex items-center justify-center h-full px-4 py-2 text-sm font-bold text-txt-p transition-all duration-300 dark:text-darkmode-txt-p rounded-full relative
                        hover:text-orange-500
                        ${
                          pathname === child.url || pathname === `${child.url}/`
                            ? "text-orange-500"
                            : ""
                        }`}
                    >
                      <span
                        class={`absolute inset-0 rounded-full transition-all duration-300
                          hover:bg-white/30 hover:dark:bg-white/10 hover:backdrop-blur-sm
                          ${
                            pathname === child.url || pathname === `${child.url}/`
                              ? "bg-white/30 dark:bg-white/10 backdrop-blur-sm"
                              : ""
                          }`}
                      >
                      </span>
                      <span class="relative">{child.name}</span>
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))
      }
    </ul>
    <div class="order-1 ml-auto flex items-center md:order-2">
      <a
        class="mr-4 inline-block border-border text-xl text-txt-p dark:border-darkmode-border dark:text-darkmode-txt-p"
        href="/search"
        aria-label="search"
        title="搜索"
      >
        <IoSearch />
      </a>

      <!-- 随机文章按钮 -->
      <button
        id="random-article-btn"
        class="mr-4 p-2 text-orange-400 hover:text-orange-500 dark:text-orange-500 dark:hover:text-orange-400 transition-colors group"
        title="随机文章"
      >
        <svg
          class="w-5 h-5 transition-transform duration-300 group-hover:rotate-180"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            fill="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20 4v3.5a.3.3 0 0 1-.3.3H16a.3.3 0 0 1-.212-.512l1.147-1.146A8 8 0 0 0 4.34 8.54a.6.6 0 0 1-1.159-.308A10 10 0 0 1 18.207 4.54l1.147-1.146A.3.3 0 0 1 20 4zm-16 16v-3.5a.3.3 0 0 1 .3-.3H8a.3.3 0 0 1 .212.512L7.207 18A8 8 0 0 0 19.66 15.46a.6.6 0 0 1 1.159.308A10 10 0 0 1 5.793 19.46l-1.147 1.146A.3.3 0 0 1 4 20z"
          />
        </svg>
      </button>

      <ThemeSwitcher />
    </div>
    <!-- 背景玻璃效果 -->
    <!-- <div
  class="glass absolute inset-0 -z-10 lg:rounded-lg intersect:animate-fadeDown"
  >
  </div> -->
  </LiquidGlass>

  <style>
    /* 桌面端悬停显示下拉菜单和父菜单高亮 */
    @media (min-width: 768px) {
      /* 增加伪元素填补间隙，防止鼠标移出时菜单消失 */
      .group > a::after {
        content: '';
        position: absolute;
        bottom: -20px; /* 延伸到底部 */
        left: 0;
        width: 100%;
        height: 20px;
      }

      /* 悬停时下拉菜单显现 */
      .group:hover .submenu {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      /* 下拉菜单基础样式 */
      .submenu {
        transition: all 0.2s ease;
        /* 初始状态：向下偏移并隐藏 */
        transform: translateX(-50%) translateY(10px);
        left: 50%;
        opacity: 0;
        visibility: hidden;
        /* 增加顶部 padding 以便于鼠标过渡 */
        padding-top: 0.5rem; 
      }
    }

    /* 移动端菜单样式 */
    @media (max-width: 768px) {
      #nav-menu {
        position: absolute;
        top: 120%;
        right: 0;
        width: calc(50%);
        /* background: rgba(255, 255, 255, 0.9); */
        backdrop-filter: blur(10px);
        /* border-radius: 0 0 1rem 1rem; */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      }

      #nav-menu.show {
        display: block !important;
      }

      /* 移动端二级菜单样式 */
      .submenu {
        position: static !important;
        display: none !important;
        min-width: 100% !important;
        box-shadow: none !important;
        border: none !important;
        margin-top: 0.5rem;
        margin-left: 1rem;
        border-left: 2px solid rgba(249, 115, 22, 0.3);
        padding-left: 0.5rem;
        background: transparent !important;
      }

      /* 移动端显示展开的子菜单 */
      .submenu:not(.hidden) {
        display: block !important;
      }

      /* 移动端一级菜单项样式调整 */
      .group > a {
        /* border-bottom: 1px solid rgba(0, 0, 0, 0.1); */
        margin-bottom: 0;
      }
    }

    /* 深色模式下的移动端菜单 */
    @media (max-width: 768px) {
      :global(.dark) #nav-menu {
        background: rgba(31, 41, 55, 0.8);
      }

      :global(.dark) .submenu {
        background: transparent !important;
        border-left-color: rgba(249, 115, 22, 0.5) !important;
      }

      :global(.dark) .group > a {
        border-bottom-color: rgba(255, 255, 255, 0.1) !important;
      }
    }

    /* 菜单项激活状态样式优化 - 防止挤压其他菜单项 */
    #nav-menu .glass-button {
      transform: none !important;
    }

    #nav-menu .glass-button:hover {
      transform: none !important;
    }

    #nav-menu .glass-button:active {
      transform: none !important;
    }
  </style>

  <script>
    // 页面切换时更新菜单选中状态
    document.addEventListener("astro:page-load", () => {
      // The hover effect is now CSS-only, no JS needed for active state updates on hover.
    });

    // 移动端菜单切换和桌面端菜单对齐
    document.addEventListener("astro:page-load", function () {
      const navToggle = document.getElementById("nav-toggle");
      const navMenu = document.getElementById("nav-menu");

      // 监听导航切换
      if (navToggle && navMenu) {
        (navToggle as HTMLInputElement).addEventListener("change", function () {
          if ((this as HTMLInputElement).checked) {
            navMenu.classList.remove("hidden");
            navMenu.classList.add("show");
          } else {
            navMenu.classList.add("hidden");
            navMenu.classList.remove("show");
          }
        });
      }

      // 点击菜单项后关闭移动端菜单
      const menuLinks = document.querySelectorAll("#nav-menu a");
      menuLinks.forEach((link) => {
        link.addEventListener("click", function () {
          if (navToggle && navMenu) {
            (navToggle as HTMLInputElement).checked = false;
            navMenu.classList.add("hidden");
            navMenu.classList.remove("show");
          }
        });
      });

      // 移动端处理：添加二级菜单支持
      const dropdownItems = document.querySelectorAll(".group");
      dropdownItems.forEach((dropdown) => {
        const toggle = dropdown.querySelector("a");
        const menu = dropdown.querySelector(".submenu");

        if (toggle && menu) {
          // 移动端点击父菜单项切换子菜单显示
          toggle.addEventListener("click", function (e) {
            if (window.innerWidth < 768) {
              e.preventDefault(); // 阻止默认跳转行为，因为我们需要显示子菜单
              // 切换子菜单的显示状态
              const isHidden = menu.classList.contains("hidden");
              menu.classList.toggle("hidden", !isHidden);

              // 在移动设备上防止菜单关闭
              e.stopPropagation();
            }
          });
        }
      });

      // 桌面端下拉菜单居中对齐逻辑
      if (window.innerWidth >= 768) {
        const dropdownGroups = document.querySelectorAll('.dropdown.group');

        dropdownGroups.forEach(group => {
          const parentLink = group.querySelector('a');
          const submenu = group.querySelector('.submenu');

          if (parentLink && submenu) {
            // 在悬停时计算并调整下拉菜单位置以实现中心对齐
            group.addEventListener('mouseenter', () => {
              // 获取父菜单项的位置信息
              const parentRect = parentLink.getBoundingClientRect();
              const submenuRect = submenu.getBoundingClientRect();

              // 计算父菜单项的中心点
              const parentCenter = parentRect.left + parentRect.width / 2;

              // 计算下拉菜单的中心点（初始位置）
              const submenuCenter = submenuRect.left + submenuRect.width / 2;

              // 计算需要的偏移量
              const offset = parentCenter - submenuCenter;

              // 应用偏移量以确保中心对齐
              (submenu as HTMLElement).style.left = `calc(50% + ${offset}px)`;
            });

            // 鼠标离开时重置位置
            group.addEventListener('mouseleave', () => {
              (submenu as HTMLElement).style.left = '50%';
            });
          }
        });
      }
    });

    // 随机文章按钮点击事件
    document.addEventListener("astro:page-load", function () {
      const randomBtn = document.getElementById("random-article-btn");
      if (randomBtn) {
        randomBtn.addEventListener("click", async function () {
          const button = this as HTMLButtonElement;
          const originalHTML = button.innerHTML; // 在函数开始时保存原始HTML

          try {
            // 显示加载状态
            button.disabled = true;
            button.innerHTML =
              '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';

            // 获取所有已发布的博客文章
            const response = await fetch("/api/blog-articles.json");
            if (!response.ok) {
              throw new Error("无法获取文章列表");
            }
            const articles = await response.json();
            if (!articles || articles.length === 0) {
              throw new Error("没有找到可用的文章");
            }


            // 随机选择一篇文章
            const randomIndex = Math.floor(Math.random() * articles.length);
            const randomArticle = articles[randomIndex];

            // 跳转到随机文章页面
            window.location.href = `/blog/${randomArticle.slug}`;
          } catch (error) {
            console.error("获取随机文章失败:", error);
            // 恢复按钮状态
            button.disabled = false;
            button.innerHTML = originalHTML;

            // 显示错误提示
            alert("获取随机文章失败，请稍后重试");
          }
        });
      }
    });
  </script>
</header>
