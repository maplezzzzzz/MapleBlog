---
import { plainify } from "@lib/textConverter";
import Footer from "@components/base/Footer.astro";
import Header from "@components/base/Header.astro";
import "@/styles/main.scss";
import { ClientRouter } from "astro:transitions";
import Background from "@/components/base/Background.astro";
import { Tooltips } from "astro-tooltips";
import { SITE_INFO } from "@lib/config";
import { isDevelopment } from "@lib/env";

// types for frontmatters
export interface Props {
  title?: string;
  description?: string | null;
  image?: string;
  noindex?: boolean;
  canonical?: string;
  keywords?: string;
}

const { title, description, image, noindex, canonical, keywords } = Astro.props;

// è·å–åŸºç¡€è®¾ç½®
let basicSettings: any = {};
let seoSettings: any = {};
let customSettings: any = {};

// åŸºç¡€è®¾ç½®å˜é‡
// console.log("ç½‘ç«™åŸºç¡€ä¿¡æ¯ï¼š", basicSettings);
const siteTitle = SITE_INFO.SITE_NAME;
const siteSubTitle = SITE_INFO.SUBNAME;
const siteImage = SITE_INFO.LOGO_IMAGE || "/favicon.ico";
const baseUrl = SITE_INFO.URL || "/";
const siteKeywords = basicSettings?.site_keywords || "";
const siteTagline = basicSettings?.site_tagline || "";

// SEOè®¾ç½®å˜é‡
const metaTitle = seoSettings?.seo_meta_title || "";
const metaDescription = description || SITE_INFO.DESCRIPTION;
const metaKeywords = keywords || SITE_INFO.KEY_WORDS;
const googleAnalyticsId = SITE_INFO.GOOGLE_ANALYTICS_ID || "";
const baiduAnalyticsId = SITE_INFO.BAIDU_ANALYTICS_ID || "";

// è‡ªå®šä¹‰ä»£ç è®¾ç½®å˜é‡
const customHeaderCode = customSettings?.custom_header_code || "";
const customFooterCode = customSettings?.custom_footer_code || "";
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- favicon -->
    <link
      rel="logo-192x192"
      sizes="180x180"
      href="/favicon/logo-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon/favicon-16x16.png"
    />

    <link rel="sitemap" href="/sitemap-index.xml" />
    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml" />

    <meta name="theme-name" content="pages" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: light)"
      content="#fff"
    />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#000"
    />
    <meta name="generator" content={Astro.generator} />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=5"
    />

    <title>
      {title ? plainify(title) + " | " : ""}{siteTitle + " | " + siteSubTitle}
    </title>

    {canonical && <link rel="canonical" href={canonical} item-prop="url" />}

    <meta
      name="description"
      content={plainify(description ? description : metaDescription)}
    />
    {metaKeywords && <meta name="keywords" content={metaKeywords} />}

    <meta
      property="og:title"
      content={`${plainify(metaTitle + " " + siteTagline)}`}
    />
    <meta
      property="og:description"
      content={plainify(description ? description : metaDescription)}
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content={`${baseUrl}/${Astro.url.pathname.replace("/", "")}`}
    />
    <meta
      property="og:image"
      content={`${baseUrl}${image ? image : siteImage}`}
    />

    <meta
      name="twitter:title"
      content={`${plainify(metaTitle + " " + siteTagline)}`}
    />
    <meta
      name="twitter:description"
      content={plainify(description ? description : metaDescription)}
    />
    <meta
      name="twitter:image"
      content={`${baseUrl}${image ? image : siteImage}`}
    />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- DNSé¢„è¿æ¥å’Œé¢„å–ä¼˜åŒ– -->
    <!-- <link rel="preconnect" href="https://fontsapi.zeoseven.com" crossorigin /> -->
    <!-- <link rel="preconnect" href="https://fontsapi-storage.zeoseven.com" crossorigin> -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link
      rel="preconnect"
      href="https://www.googletagmanager.com"
      crossorigin
    />
    <link rel="preconnect" href="https://hm.baidu.com" crossorigin />

    <!-- é¢„å–å…³é”®èµ„æº -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />

    <!-- Katex -->
    <link
      rel="preload"
      as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
      integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      onload="this.rel='stylesheet'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
        integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      />
    </noscript>
    <!-- é¢„åŠ è½½å…³é”®è„šæœ¬ -->
    <link
      rel="preload"
      as="script"
      href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
      integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
      crossorigin="anonymous"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
      integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      defer></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"
      integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.js"
      integrity="sha384-dZ/hSVfTPHuzXyECOYCetAvMd0cgqWxN5Fh+hnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
      crossorigin="anonymous"
      defer></script>
    <!-- https://docs.astro.build/en/guides/view-transitions -->
    <ClientRouter fallback="swap" />
    <Tooltips interactive={false} delay={[100, 50]} />

    <!-- Google Analytics - ä»…åœ¨ç”Ÿäº§ç¯å¢ƒåŠ è½½ -->
    {
      !isDevelopment() && googleAnalyticsId && (
        <>
          <script
            async
            src={`https://www.googletagmanager.com/gtag/js?id=${googleAnalyticsId}`}
          />
          <script
            set:html={`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '${googleAnalyticsId}');
        `}
          />
        </>
      )
    }

    <!-- ç™¾åº¦ç»Ÿè®¡ - ä»…åœ¨ç”Ÿäº§ç¯å¢ƒåŠ è½½ -->
    {
      !isDevelopment() && baiduAnalyticsId && (
        <script
          set:html={`
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?${baiduAnalyticsId}";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      `}
        />
      )
    }
    <meta name="baidu-site-verification" content="codeva-RmOcCYpW8H" />
    <!-- è‡ªå®šä¹‰å¤´éƒ¨ä»£ç  -->
    {customHeaderCode && <Fragment set:html={customHeaderCode} />}

    <!-- é¡µé¢åˆ‡æ¢åŠ¨ç”»æ ·å¼ -->
    <style>
      /* é¡µé¢åˆ‡æ¢åŠ è½½åŠ¨ç”» */
      .page-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          visibility 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .page-loading.active {
        opacity: 1;
        visibility: visible;
      }

      .dark .page-loading {
        background: linear-gradient(
          135deg,
          rgba(60, 60, 60, 0.9),
          rgba(19, 19, 19, 0.9)
        );
      }

      /* åŠ è½½åŠ¨ç”»å®¹å™¨ - åˆ›æ„é£æ ¼ */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        padding: 3rem 2.5rem;
        animation: containerBounce 2s ease-in-out infinite;
        transform-style: preserve-3d;
      }

      /* ä¸»åŠ è½½åŠ¨ç”» - åˆ›æ„é£æ ¼ */
      .loading-spinner {
        width: 3rem;
        height: 3rem;
        position: relative;
        animation: spinBounce 1.5s ease-in-out infinite;
      }

      .loading-spinner::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 4px solid transparent;
        border-top: 4px solid #19dab5;
        border-right: 4px solid #2c3e50;
        border-radius: 50%;
        animation: rainbowSpin 2s linear infinite;
      }

      .loading-spinner::after {
        content: "";
        position: absolute;
        top: 6px;
        left: 6px;
        width: calc(100% - 12px);
        height: calc(100% - 12px);
        border: 3px solid transparent;
        border-bottom: 4px solid #21a6ff;
        border-left: 4px solid #ffa508;
        border-radius: 50%;
        animation: rainbowSpin 1.5s linear infinite reverse;
      }

      .dark .loading-spinner::before {
        border-top: 4px solid #16a085;
        border-right: 4px solid #2c3e50;
      }

      .dark .loading-spinner::after {
        border-bottom: 4px solid #3498db;
        border-left: 4px solid #16a085;
      }

      /* åŠ è½½æ–‡å­— - å½©è™¹æ¸å˜ */
      .loading-text {
        font-size: 1rem;
        background: linear-gradient(
          45deg,
          #09141f,
          #1b3d5e,
          #195b87,
          #0a8de4,
          #dbf1ff,
          #0dc3ae,
          #23277d,
          #170339
        );
        background-size: 300% 300%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 600;
        letter-spacing: 0.1em;
        animation:
          textPulse 2s ease-in-out infinite,
          gradientMove 3s ease-in-out infinite;
        text-shadow: 0 0 20px rgba(255, 107, 157, 0.3);
        transition: opacity 0.3s ease;
        min-height: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .dark .loading-text {
        background: linear-gradient(
          45deg,
          #042545,
          #446a90,
          #2fa9fa,
          #1d84c9,
          #dbf1ff,
          #11ad8e,
          #2b3876
        );
        background-size: 300% 300%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 25px rgba(255, 139, 171, 0.4);
      }

      /* è¿›åº¦æ¡ - å½©è™¹é£æ ¼ */
      .loading-progress {
        width: 8rem;
        height: 0.25rem;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0.125rem;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      .loading-progress::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          #ff6b9d,
          #4ecdc4,
          #45b7d1,
          #96ceb4,
          #feca57
        );
        border-radius: 0.125rem;
        animation:
          progress 2.5s ease-in-out infinite,
          rainbowShift 3s ease-in-out infinite;
        box-shadow: 0 0 10px rgba(255, 107, 157, 0.5);
      }

      .dark .loading-progress {
        background: rgba(255, 255, 255, 0.1);
      }

      .dark .loading-progress::after {
        background: linear-gradient(
          90deg,
          #ff8fab,
          #6ee5d8,
          #5bc5e5,
          #a8d8c8,
          #fed36a
        );
        box-shadow: 0 0 15px rgba(255, 139, 171, 0.6);
      }

      @keyframes rainbowShift {
        0%,
        100% {
          filter: hue-rotate(0deg);
        }
        50% {
          filter: hue-rotate(180deg);
        }
      }

      @keyframes rainbowSpin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes spinBounce {
        0%,
        100% {
          transform: scale(1) rotate(0deg);
        }
        25% {
          transform: scale(1.1) rotate(90deg);
        }
        50% {
          transform: scale(1.05) rotate(180deg);
        }
        75% {
          transform: scale(0.95) rotate(270deg);
        }
      }

      @keyframes textPulse {
        0%,
        100% {
          opacity: 0.7;
          transform: scale(1);
        }
        50% {
          opacity: 1;
          transform: scale(1.05);
        }
      }

      @keyframes containerBounce {
        0%,
        100% {
          transform: translateY(0px) scale(1);
        }
        25% {
          transform: translateY(-3px) scale(1.02);
        }
        50% {
          transform: translateY(-5px) scale(1.05);
        }
        75% {
          transform: translateY(-2px) scale(1.02);
        }
      }

      @keyframes progress {
        0% {
          width: 0%;
        }
        30% {
          width: 40%;
        }
        60% {
          width: 70%;
        }
        100% {
          width: 100%;
        }
      }

      @keyframes gradientMove {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      /* å¢å¼ºé¡µé¢è¿‡æ¸¡åŠ¨ç”» */
      .page-transition-enter {
        opacity: 0;
        transform: translateY(10px);
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }
      
      .page-transition-enter-active {
        opacity: 1;
        transform: translateY(0);
      }
      
      .page-transition-exit {
        opacity: 1;
        transform: translateY(0);
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }
      
      .page-transition-exit-active {
        opacity: 0;
        transform: translateY(-10px);
      }
      
      /* ç¦ç”¨view transitionä»¥é¿å…ç™½å± */
      ::view-transition-old(root),
      ::view-transition-new(root) {
        animation: none;
      }
    </style>

    <!-- Supabase å·²ç§»é™¤ï¼šä¸å†åŠ è½½å…¨å±€å®¢æˆ·ç«¯ -->
  </head>
  <body>
    <!-- SVG æ»¤é•œå®šä¹‰ - å¿…é¡»åœ¨ä½¿ç”¨å‰å®šä¹‰ -->
    <svg style="position: absolute; width: 0; height: 0; pointer-events: none;">
      <defs>
        <filter
          id="glass-distortion"
          x="0%"
          y="0%"
          width="100%"
          height="100%"
          filterUnits="objectBoundingBox"
        >
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.001 0.004"
            numOctaves="1"
            seed="17"
            result="turbulence"></feTurbulence>
          <!-- Liked Seeds: 5, 14, 17 -->

          <feComponentTransfer in="turbulence" result="mapped">
            <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5"
            ></feFuncR>
            <feFuncG type="gamma" amplitude="0" exponent="1" offset="0"
            ></feFuncG>
            <feFuncB type="gamma" amplitude="0" exponent="0.5"
            ></feFuncB>
          </feComponentTransfer>

          <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap"
          ></feGaussianBlur>

          <feSpecularLighting
            in="softMap"
            surfaceScale="5"
            specularConstant="1"
            specularExponent="100"
            lighting-color="white"
            result="specLight"
          >
            <fePointLight x="-200" y="-200" z="300"></fePointLight>
          </feSpecularLighting>

          <feComposite
            in="specLight"
            operator="arithmetic"
            k1="0"
            k2="1"
            k3="1"
            k4="0"
            result="litImage"></feComposite>

          <feDisplacementMap
            in="SourceGraphic"
            in2="softMap"
            scale="100"
            xChannelSelector="R"
            yChannelSelector="G"></feDisplacementMap>
        </filter>
      </defs>
    </svg>

    <!-- é¡µé¢åŠ è½½åŠ¨ç”» -->
    <div class="page-loading">
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">åŠ è½½ä¸­...</div>
        <div class="loading-progress"></div>
      </div>
    </div>

    <Background />
    <Header />
    <main id="main-content" class="flex-1 pb-16 md:pb-36">
      <slot />
    </main>
    <Footer />
    <!-- <ObserverScript /> -->
    <!-- KaTeX åˆå§‹åŒ–è„šæœ¬ -->
    <script>
      // å®‰å…¨çš„ KaTeX æ¸²æŸ“å‡½æ•°
      function renderMathSafely() {
        if (
          typeof (window as any).renderMathInElement !== "undefined" &&
          document.body
        ) {
          try {
            (window as any).renderMathInElement(document.body, {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true },
              ],
              throwOnError: false,
            });
          } catch (error) {
            console.warn("KaTeX rendering failed:", error);
          }
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆåæ¸²æŸ“
      document.addEventListener("DOMContentLoaded", renderMathSafely);

      // Astro é¡µé¢åˆ‡æ¢åé‡æ–°æ¸²æŸ“
      document.addEventListener("astro:page-load", renderMathSafely);

      // å…¼å®¹æ€§ï¼šå¦‚æœ DOMContentLoaded å·²ç»è§¦å‘
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", renderMathSafely);
      } else {
        renderMathSafely();
      }
    </script>

    <!-- å¢å¼ºç‰ˆé¡µé¢è¿‡æ¸¡ç®¡ç†è„šæœ¬ -->
    <script>
      // é¡µé¢è¿‡æ¸¡ç®¡ç†å™¨è„šæœ¬
      class PageTransitionManager {
        constructor(options = {}) {
          this.options = {
            duration: options.duration || 300,
            easing: options.easing || 'ease',
            showLoader: options.showLoader !== false,
            loaderDelay: options.loaderDelay || 150,
            cacheEnabled: options.cacheEnabled !== false,
          };
          this.cache = new Map();
          this.isLoading = false;
          this.abortController = null;
          
          this.init();
        }

        init() {
          // ç›‘å¬é¡µé¢è·³è½¬äº‹ä»¶
          this.hookNavigationEvents();
          
          // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆäº‹ä»¶
          this.hookPageLoadEvents();
        }

        hookNavigationEvents() {
          // æ‹¦æˆªæ‰€æœ‰é“¾æ¥ç‚¹å‡»äº‹ä»¶
          document.addEventListener('click', this.handleLinkClick.bind(this));
          
          // ç›‘å¬è¡¨å•æäº¤äº‹ä»¶
          document.addEventListener('submit', this.handleFormSubmit.bind(this));
          
          // ç›‘è§†æµè§ˆå™¨å‰è¿›åé€€æŒ‰é’®
          window.addEventListener('popstate', this.handlePopState.bind(this));
        }

        hookPageLoadEvents() {
          // Astroé¡µé¢åŠ è½½äº‹ä»¶
          document.addEventListener('astro:before-preparation', this.handleBeforePreparation.bind(this));
          document.addEventListener('astro:page-load', this.handlePageLoadComplete.bind(this));
        }

        handleLinkClick(event) {
          const target = event.target;
          const link = target.closest('a');

          if (!link) return;

          const url = new URL(link.href);
          const currentUrl = new URL(window.location.href);

          // æ£€æŸ¥æ˜¯å¦æ˜¯å¤–éƒ¨é“¾æ¥æˆ–ç‰¹æ®Šé“¾æ¥
          if (url.origin !== currentUrl.origin) return;
          if (link.target === '_blank') return;
          if (link.href.startsWith('mailto:') || link.href.startsWith('tel:')) return;
          if (link.getAttribute('href')?.startsWith('#')) return;

          // å¦‚æœæ˜¯ç›¸åŒè·¯å¾„ä½†ä¸åŒhashï¼Œåˆ™ä¸æ‰§è¡Œé¡µé¢è¿‡æ¸¡
          if (url.pathname === currentUrl.pathname) {
            if (url.hash) {
              event.preventDefault();
              // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡å…ƒç´ 
              this.smoothScrollToTarget(url.hash);
            }
            return;
          }

          // æ‰§è¡Œå¹³æ»‘è¿‡æ¸¡
          event.preventDefault();
          this.navigateTo(link.href);
        }

        handleFormSubmit(event) {
          const form = event.target;
          if (form && form.method.toLowerCase() === 'get') {
            this.isLoading = true;
            if (this.options.showLoader) {
              this.showLoader();
            }
          }
        }

        handlePopState(event) {
          // é˜»æ­¢é»˜è®¤çš„é¡µé¢è·³è½¬ï¼Œæ‰§è¡Œå¹³æ»‘è¿‡æ¸¡
          this.performSmoothTransition(window.location.href);
        }

        handleBeforePreparation(event) {
          this.isLoading = true;
          if (this.options.showLoader) {
            // ä½¿ç”¨å»¶è¿Ÿé¿å…ä¸å¿…è¦çš„é—ªçƒ
            setTimeout(() => {
              if (this.isLoading) {
                this.showLoader();
              }
            }, this.options.loaderDelay);
          }
        }

        handlePageLoadComplete(event) {
          this.isLoading = false;
          if (this.options.showLoader) {
            this.hideLoader();
          }
          
          // è§¦å‘è¿‡æ¸¡å®Œæˆäº‹ä»¶
          this.dispatchTransitionCompleteEvent();
        }

        async navigateTo(url) {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          this.isLoading = true;
          if (this.options.showLoader) {
            // å»¶è¿Ÿæ˜¾ç¤ºloaderä»¥é¿å…å¿«é€Ÿè·³è½¬çš„é—ªçƒ
            setTimeout(() => {
              if (this.isLoading) {
                this.showLoader();
              }
            }, this.options.loaderDelay);
          }

          // æ‰§è¡Œé¡µé¢è¿‡æ¸¡
          await this.performSmoothTransition(url);
        }

        async performSmoothTransition(url) {
          return new Promise((resolve) => {
            // ä¿å­˜å½“å‰é¡µé¢çŠ¶æ€
            const currentPage = document.documentElement.cloneNode(true);

            // æ›´æ–°æµè§ˆå™¨å†å²è®°å½•
            history.pushState({}, '', url);

            // å‘èµ·é¡µé¢è¯·æ±‚
            this.abortController = new AbortController();
            
            fetch(url, {
              signal: this.abortController.signal
            })
            .then(response => response.text())
            .then(html => {
              // è§£ææ–°çš„HTMLå†…å®¹
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              
              // æå–å…³é”®å†…å®¹éƒ¨åˆ†
              const newMain = doc.querySelector('main#main-content');
              const newTitle = doc.querySelector('title');
              
              if (newMain && newTitle) {
                // æ‰§è¡Œè¿‡æ¸¡åŠ¨ç”»
                this.executeTransitionAnimation(newMain, newTitle.textContent || '');
                
                // æ›´æ–°é¡µé¢å†…å®¹
                const currentMain = document.querySelector('main#main-content');
                if (currentMain) {
                  currentMain.replaceWith(newMain);
                }
                
                // æ›´æ–°æ ‡é¢˜
                document.title = newTitle.textContent || '';
                
                // æ›´æ–°å…ƒæ•°æ®
                this.updateMetaTags(doc);
                
                // å®Œæˆè¿‡æ¸¡
                this.onTransitionComplete(resolve);
              } else {
                // å¦‚æœæ— æ³•è§£æå†…å®¹ï¼Œæ‰§è¡Œå®Œæ•´é¡µé¢åˆ·æ–°
                window.location.href = url;
              }
            })
            .catch(error => {
              if (error.name !== 'AbortError') {
                console.error('é¡µé¢åŠ è½½å¤±è´¥:', error);
                // å‡ºé”™æ—¶æ‰§è¡Œå®Œæ•´é¡µé¢è·³è½¬
                window.location.href = url;
              }
            });
          });
        }

        executeTransitionAnimation(newMain) {
          const currentMain = document.querySelector('main#main-content');
          if (!currentMain) return;

          // åº”ç”¨è¿‡æ¸¡æ ·å¼
          currentMain.style.position = 'relative';
          currentMain.style.zIndex = '1';
          currentMain.style.opacity = '1';
          currentMain.style.transition = `opacity ${this.options.duration}ms ${this.options.easing}, transform ${this.options.duration}ms ${this.options.easing}`;
          
          // æ·¡å‡ºå½“å‰å†…å®¹
          currentMain.style.opacity = '0';
          currentMain.style.transform = 'translateY(10px)';
          
          // åœ¨åŠ¨ç”»ç»“æŸååº”ç”¨æ–°å†…å®¹
          setTimeout(() => {
            // å°†æ–°å†…å®¹æ·¡å…¥
            newMain.style.position = 'relative';
            newMain.style.zIndex = '1';
            newMain.style.opacity = '0';
            newMain.style.transform = 'translateY(-10px)';
            newMain.style.transition = `opacity ${this.options.duration}ms ${this.options.easing}, transform ${this.options.duration}ms ${this.options.easing}`;
            
            // ç¡®ä¿DOMæ›´æ–°åå†æ‰§è¡ŒåŠ¨ç”»
            requestAnimationFrame(() => {
              newMain.style.opacity = '1';
              newMain.style.transform = 'translateY(0)';
            });
          }, this.options.duration / 2);
        }

        onTransitionComplete(callback) {
          // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ä»¥ç¡®ä¿åŠ¨ç”»å®Œå…¨ç»“æŸ
          setTimeout(() => {
            this.isLoading = false;
            if (this.options.showLoader) {
              this.hideLoader();
            }
            this.dispatchTransitionCompleteEvent();
            callback();
          }, this.options.duration / 2);
        }

        dispatchTransitionCompleteEvent() {
          const event = new CustomEvent('page-transition-complete', {
            detail: { url: window.location.href }
          });
          document.dispatchEvent(event);
        }

        updateMetaTags(newDoc) {
          // æ›´æ–°æè¿°
          const newDescription = newDoc.querySelector('meta[name="description"]');
          if (newDescription) {
            const currentDescription = document.querySelector('meta[name="description"]');
            if (currentDescription) {
              currentDescription.setAttribute('content', newDescription.getAttribute('content'));
            } else {
              document.head.appendChild(newDescription.cloneNode(true));
            }
          }
          
          // æ›´æ–°Open Graphæ ‡ç­¾
          const ogTags = newDoc.querySelectorAll('meta[property^="og:"]');
          ogTags.forEach(tag => {
            const prop = tag.getAttribute('property');
            if (prop) {
              const currentTag = document.querySelector(`meta[property="${prop}"]`);
              if (currentTag) {
                currentTag.setAttribute('content', tag.getAttribute('content'));
              } else {
                document.head.appendChild(tag.cloneNode(true));
              }
            }
          });
          
          // æ›´æ–°Twitter Cardæ ‡ç­¾
          const twitterTags = newDoc.querySelectorAll('meta[name^="twitter:"]');
          twitterTags.forEach(tag => {
            const name = tag.getAttribute('name');
            if (name) {
              const currentTag = document.querySelector(`meta[name="${name}"]`);
              if (currentTag) {
                currentTag.setAttribute('content', tag.getAttribute('content'));
              } else {
                document.head.appendChild(tag.cloneNode(true));
              }
            }
          });
        }

        showLoader() {
          const loader = document.querySelector('.page-loading');
          if (loader) {
            // éšæœºåŠ è½½æ–‡æœ¬
            const texts = [
              "âœ¨ é­”æ³•æ­£åœ¨æ–½å±•ä¸­...",
              "ğŸŒˆ å½©è™¹æ¡¥æ­å»ºä¸­...",
              "ğŸ¨ åˆ›æ„æ­£åœ¨è¿¸å‘...",
              "ğŸš€ å³å°†èµ·é£...",
              "ğŸ’« æ˜Ÿè¾°å¤§æµ·ç­‰ä½ æ¥...",
              "ğŸŒ¹ ç²¾å½©å†…å®¹å‡†å¤‡ä¸­...",
              "ğŸŒŸ é—ªäº®ç™»åœºå€’è®¡æ—¶..."
            ];
            const textElement = loader.querySelector('#loading-text');
            if (textElement) {
              textElement.textContent = texts[Math.floor(Math.random() * texts.length)];
            }
            
            // å»¶è¿Ÿæ˜¾ç¤ºï¼Œé¿å…å¿«é€Ÿè·³è½¬çš„é—ªçƒ
            setTimeout(() => {
              if (this.isLoading) {
                loader.classList.add('active');
              }
            }, 50);
          }
        }

        hideLoader() {
          const loader = document.querySelector('.page-loading');
          if (loader) {
            loader.classList.remove('active');
          }
        }

        smoothScrollToTarget(hash) {
          const element = document.querySelector(hash);
          if (element) {
            element.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        }

        destroy() {
          if (this.abortController) {
            this.abortController.abort();
          }
          
          // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
          document.removeEventListener('click', this.handleLinkClick.bind(this));
          document.removeEventListener('submit', this.handleFormSubmit.bind(this));
          window.removeEventListener('popstate', this.handlePopState.bind(this));
          document.removeEventListener('astro:before-preparation', this.handleBeforePreparation.bind(this));
          document.removeEventListener('astro:page-load', this.handlePageLoadComplete.bind(this));
        }
      }

      // åˆå§‹åŒ–é¡µé¢è¿‡æ¸¡ç®¡ç†å™¨
      document.addEventListener('DOMContentLoaded', () => {
        const pageTransitionManager = new PageTransitionManager({
          duration: 300,
          showLoader: true,
          loaderDelay: 100
        });
      });
    </script>

    <!-- è‡ªå®šä¹‰åº•éƒ¨ä»£ç  -->
    {customFooterCode && <Fragment set:html={customFooterCode} />}
  </body>
</html>