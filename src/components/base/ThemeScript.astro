<script is:inline>
  // 立即执行以防止闪烁
  (function() {
    const theme = localStorage.getItem("theme");
    const isDark = theme === "dark" || (!theme && window.matchMedia("(prefers-color-scheme: dark)").matches);
    if (isDark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  })();

  // 页面加载和切换后的初始化逻辑
  function initTheme() {
    const themeSwitchers = document.querySelectorAll("[data-theme-switcher]");
    const isDark = document.documentElement.classList.contains("dark");

    // 同步所有切换按钮的状态
    themeSwitchers.forEach((el) => {
      el.checked = isDark;
      
      // 移除旧的监听器（如果存在），防止重复绑定
      // 由于是匿名函数难以移除，我们采用 cloneNode 或者简单的标志位
      // Astro 的 View Transitions 会重新运行脚本，所以只需确保不累积
      // 最简单的方式是直接覆盖 onclick 或 onchange，但这里用 addEventListener
      // 我们可以给元素加个标记
      if (el.dataset.initialized) return;
      
      el.addEventListener("change", (e) => {
        const checked = e.target.checked;
        if (checked) {
          document.documentElement.classList.add("dark");
          localStorage.setItem("theme", "dark");
        } else {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("theme", "light");
        }
        
        // 同步其他可能存在的切换按钮（例如移动端和桌面端各有一个）
        document.querySelectorAll("[data-theme-switcher]").forEach(other => {
            if (other !== el) other.checked = checked;
        });
      });
      
      el.dataset.initialized = "true";
    });
  }

  // 绑定事件
  document.addEventListener("DOMContentLoaded", initTheme);
  document.addEventListener("astro:page-load", initTheme);
  document.addEventListener("astro:after-swap", initTheme);
</script>
