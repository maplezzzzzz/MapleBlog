---
import Layout from '../../layouts/AdminLayout.astro';

const title = 'Python功能集成';
---

<Layout title={title}>
  <div class="admin-container">
    <h2>Python功能集成</h2>
    
    <div class="integration-features">
      <div class="feature-card">
        <h3>文本分析</h3>
        <p>使用Python进行情感分析和关键词提取</p>
        <div class="feature-content">
          <textarea id="text-input" placeholder="输入要分析的文本..."></textarea>
          <div class="controls">
            <select id="language-select">
              <option value="zh">中文</option>
              <option value="en">英文</option>
            </select>
            <button class="admin-btn" onclick="analyzeText()">分析文本</button>
          </div>
          <div id="text-analysis-result" class="result-container"></div>
        </div>
      </div>
      
      <div class="feature-card">
        <h3>内容优化</h3>
        <p>获取内容SEO和质量优化建议</p>
        <div class="feature-content">
          <input type="text" id="content-title" placeholder="文章标题">
          <textarea id="content-body" placeholder="文章内容..."></textarea>
          <input type="text" id="content-keywords" placeholder="关键词（用逗号分隔）">
          <button class="admin-btn" onclick="optimizeContent()">优化内容</button>
          <div id="content-optimization-result" class="result-container"></div>
        </div>
      </div>
      
      <div class="feature-card">
        <h3>数据可视化</h3>
        <p>使用Python生成图表和可视化</p>
        <div class="feature-content">
          <div class="form-row">
            <input type="text" id="chart-title" placeholder="图表标题">
            <select id="chart-type">
              <option value="bar">柱状图</option>
              <option value="line">折线图</option>
              <option value="pie">饼图</option>
              <option value="scatter">散点图</option>
            </select>
          </div>
          <textarea id="chart-data" placeholder='输入数据 (JSON格式, 例如: [{"x": "A", "y": 10}, {"x": "B", "y": 20}])'></textarea>
          <button class="admin-btn" onclick="createVisualization()">生成图表</button>
          <div id="visualization-result" class="result-container">
            <div id="chart-placeholder" style="display: none;">
              <img id="chart-image" src="" alt="生成的图表">
              <p><a id="chart-download-link" href="#" download>下载图表</a></p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="feature-card">
        <h3>高级分析</h3>
        <p>复杂数据分析和报告生成</p>
        <div class="feature-content">
          <button class="admin-btn" onclick="generateTrafficReport()">生成流量报告</button>
          <button class="admin-btn" onclick="generateContentReport()">生成内容报告</button>
          <button class="admin-btn" onclick="generateSEOReport()">生成SEO报告</button>
          <div id="advanced-analysis-result" class="result-container"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PYTHON_API_BASE = 'http://localhost:8000'; // Python API的地址

    // 文本分析功能
    async function analyzeText() {
      const textInput = document.getElementById('text-input');
      const languageSelect = document.getElementById('language-select');
      const resultDiv = document.getElementById('text-analysis-result');

      if (!textInput || !languageSelect || !resultDiv) {
        console.error('页面元素未找到');
        return;
      }

      const text = textInput.value;
      const language = languageSelect.value;

      if (!text) {
        alert('请输入要分析的文本');
        return;
      }

      try {
        const response = await fetch(`${PYTHON_API_BASE}/api/text-analysis`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ text, language })
        });

        const result = await response.json();

        if (result.success) {
          resultDiv.innerHTML = `
            <h4>分析结果:</h4>
            <p><strong>情感:</strong> ${result.sentiment.label} (得分: ${result.sentiment.score})</p>
            <p><strong>关键词:</strong> ${result.keywords.join(', ')}</p>
          `;
        } else {
          resultDiv.innerHTML = `<p class="error">分析失败: ${result.error || '未知错误'}</p>`;
        }
      } catch (error: any) {
        console.error('文本分析请求失败:', error);
        if (resultDiv) {
          resultDiv.innerHTML = `<p class="error">请求失败: ${error.message}</p>`;
        }
      }
    }

    // 内容优化功能
    async function optimizeContent() {
      const titleInput = document.getElementById('content-title');
      const contentInput = document.getElementById('content-body');
      const keywordsInput = document.getElementById('content-keywords');
      const resultDiv = document.getElementById('content-optimization-result');

      if (!titleInput || !contentInput || !keywordsInput || !resultDiv) {
        console.error('页面元素未找到');
        return;
      }

      const title = titleInput.value;
      const content = contentInput.value;
      const keywordsInputValue = keywordsInput.value;
      const keywords = keywordsInputValue ? keywordsInputValue.split(',').map((k: string) => k.trim()) : [];

      if (!title || !content) {
        alert('请输入标题和内容');
        return;
      }

      try {
        const response = await fetch(`${PYTHON_API_BASE}/api/content-optimization`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title, content, keywords })
        });

        const result = await response.json();

        if (result.success) {
          resultDiv.innerHTML = `
            <h4>优化报告:</h4>
            <p><strong>整体分数:</strong> ${result.report.overall_score}/100</p>
            <p><strong>字数:</strong> ${result.report.word_count}</p>
            <p><strong>可读性分数:</strong> ${result.report.readability.readability_score}/100</p>
            <h5>建议:</h5>
            <ul>
              ${(result.report.suggestions as string[]).map((s: string) => `<li>${s}</li>`).join('')}
            </ul>
          `;
        } else {
          resultDiv.innerHTML = `<p class="error">优化失败: 未知错误</p>`;
        }
      } catch (error: any) {
        console.error('内容优化请求失败:', error);
        if (resultDiv) {
          resultDiv.innerHTML = `<p class="error">请求失败: ${error.message}</p>`;
        }
      }
    }

    // 数据可视化功能
    async function createVisualization() {
      const titleInput = document.getElementById('chart-title');
      const typeSelect = document.getElementById('chart-type');
      const dataInput = document.getElementById('chart-data');
      const resultDiv = document.getElementById('visualization-result');
      const placeholder = document.getElementById('chart-placeholder');
      const image = document.getElementById('chart-image');
      const link = document.getElementById('chart-download-link');

      if (!titleInput || !typeSelect || !dataInput || !resultDiv || !placeholder || !image || !link) {
        console.error('页面元素未找到');
        return;
      }

      const title = titleInput.value;
      const type = typeSelect.value;
      const dataInputValue = dataInput.value;

      if (!title || !dataInputValue) {
        alert('请输入图表标题和数据');
        return;
      }

      let data;
      try {
        data = JSON.parse(dataInputValue);
      } catch (e) {
        alert('数据格式错误，请输入有效的JSON格式');
        return;
      }

      try {
        const response = await fetch(`${PYTHON_API_BASE}/api/visualization`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ data, chart_type: type, title })
        });

        const result = await response.json();

        if (result.success) {
          (image as HTMLImageElement).src = `${PYTHON_API_BASE}${result.image_url}`;
          (link as HTMLAnchorElement).href = `${PYTHON_API_BASE}${result.image_url}`;
          (placeholder as HTMLElement).style.display = 'block';

          resultDiv.innerHTML = '';
          resultDiv.appendChild(placeholder);
        } else {
          resultDiv.innerHTML = `<p class="error">生成图表失败: ${result.error || '未知错误'}</p>`;
        }
      } catch (error: any) {
        console.error('可视化请求失败:', error);
        if (resultDiv) {
          resultDiv.innerHTML = `<p class="error">请求失败: ${error.message}</p>`;
        }
      }
    }

    // 生成流量报告
    async function generateTrafficReport() {
      const resultDiv = document.getElementById('advanced-analysis-result');
      if (!resultDiv) {
        console.error('结果容器未找到');
        return;
      }

      try {
        const response = await fetch(`${PYTHON_API_BASE}/api/report/traffic`);
        const result = await response.json();
        displayReport('流量报告', result, resultDiv);
      } catch (error: any) {
        console.error('获取流量报告失败:', error);
        resultDiv.innerHTML = `<p class="error">获取报告失败: ${error.message}</p>`;
      }
    }

    // 生成内容报告
    async function generateContentReport() {
      const resultDiv = document.getElementById('advanced-analysis-result');
      if (!resultDiv) {
        console.error('结果容器未找到');
        return;
      }

      try {
        const response = await fetch(`${PYTHON_API_BASE}/api/report/content`);
        const result = await response.json();
        displayReport('内容报告', result, resultDiv);
      } catch (error: any) {
        console.error('获取内容报告失败:', error);
        resultDiv.innerHTML = `<p class="error">获取报告失败: ${error.message}</p>`;
      }
    }

    // 生成SEO报告
    async function generateSEOReport() {
      const resultDiv = document.getElementById('advanced-analysis-result');
      if (!resultDiv) {
        console.error('结果容器未找到');
        return;
      }

      try {
        const response = await fetch(`${PYTHON_API_BASE}/api/report/seo`);
        const result = await response.json();
        displayReport('SEO报告', result, resultDiv);
      } catch (error: any) {
        console.error('获取SEO报告失败:', error);
        resultDiv.innerHTML = `<p class="error">获取报告失败: ${error.message}</p>`;
      }
    }

    // 显示报告的辅助函数
    function displayReport(title: string, report: any, resultDiv: HTMLElement) {
      if (report.success) {
        let reportHtml = `<h4>${title}</h4>`;

        for (const [key, value] of Object.entries(report)) {
          if (key !== 'success' && key !== 'generated_at' && key !== 'report_type') {
            if (typeof value === 'object' && value !== null) {
              if (Array.isArray(value)) {
                reportHtml += `<h5>${key}:</h5><ul>`;
                value.forEach(item => {
                  if (typeof item === 'object') {
                    reportHtml += '<li>';
                    for (const [subKey, subValue] of Object.entries(item)) {
                      reportHtml += `<strong>${subKey}:</strong> ${subValue} `;
                    }
                    reportHtml += '</li>';
                  } else {
                    reportHtml += `<li>${item}</li>`;
                  }
                });
                reportHtml += '</ul>';
              } else {
                reportHtml += `<h5>${key}:</h5><ul>`;
                for (const [subKey, subValue] of Object.entries(value)) {
                  reportHtml += `<li><strong>${subKey}:</strong> ${subValue}</li>`;
                }
                reportHtml += '</ul>';
              }
            } else {
              reportHtml += `<p><strong>${key}:</strong> ${value}</p>`;
            }
          }
        }

        resultDiv.innerHTML = reportHtml;
      } else {
        resultDiv.innerHTML = `<p class="error">获取报告失败: ${report.error || '未知错误'}</p>`;
      }
    }
  </script>
  
  <style>
    .integration-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .feature-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .feature-card h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    
    .feature-content {
      margin-top: 15px;
    }
    
    .feature-content textarea,
    .feature-content input {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .feature-content textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .controls select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .form-row input,
    .form-row select {
      flex: 1;
    }
    
    .result-container {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #3498db;
    }
    
    .result-container h4 {
      margin-top: 0;
      color: #2c3e50;
    }
    
    .result-container ul {
      padding-left: 20px;
    }
    
    .result-container .error {
      color: #e74c3c;
    }
    
    #chart-placeholder {
      text-align: center;
    }
    
    #chart-image {
      max-width: 100%;
      margin: 10px 0;
    }
  </style>
</Layout>