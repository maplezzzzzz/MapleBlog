---
import Layout from '../../../layouts/AdminLayout.astro';
import { getCollection } from 'astro:content';

// è·å–æ‰€æœ‰å†…å®¹ç±»å‹çš„æ•°æ®
const allBlogPosts = await getCollection('blog');
const pages = await getCollection('pages');
const categories = await getCollection('categories');
const tags = await getCollection('tags');
const notes = await getCollection('notes');

// æ–‡ç« åˆ†é¡µé€»è¾‘
const pageSize = 10;
const currentPage = Number(Astro.url.searchParams.get('page') || 1);
const totalPosts = allBlogPosts.length;
const totalPages = Math.ceil(totalPosts / pageSize);
const startIdx = (currentPage - 1) * pageSize;
const endIdx = startIdx + pageSize;

// æŒ‰æ—¥æœŸé™åºæ’åºå¹¶åˆ†é¡µ
const blogPosts = allBlogPosts
    .sort((a, b) => (b.data.publishedAt?.getTime() || 0) - (a.data.publishedAt?.getTime() || 0))
    .slice(startIdx, endIdx);
---

<Layout title="å†…å®¹ç®¡ç†">
  <div class="admin-container">
    <h2>å†…å®¹ç®¡ç†</h2>

    <div class="admin-tabs">
      <button class="tab-btn active" data-tab="posts">æ–‡ç« </button>
      <button class="tab-btn" data-tab="notes">åŠ¨æ€</button>
      <button class="tab-btn" data-tab="pages">é¡µé¢</button>
      <button class="tab-btn" data-tab="categories">åˆ†ç±»</button>
      <button class="tab-btn" data-tab="tags">æ ‡ç­¾</button>
    </div>

    <!-- æ–‡ç« ç®¡ç†æ ‡ç­¾é¡µ -->
    <div class="tab-content active" id="posts-tab">
      <div class="admin-controls flex flex-col gap-4">
        <div class="flex justify-between items-center w-full">
            <div class="flex items-center gap-4">
                <a href="/admin/article-editor" class="action-btn publish-btn text-white no-underline flex items-center gap-2">
                    <span class="text-lg">+</span> æ–°å»ºæ–‡ç« 
                </a>
                <!-- ç­›é€‰å’Œæœç´¢ -->
                <div class="flex items-center gap-2">
                    <select id="status-filter" class="form-select text-sm py-1 px-2 border rounded h-9">
                        <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="published">å·²å‘å¸ƒ</option>
                        <option value="draft">è‰ç¨¿/æœªå‘å¸ƒ</option>
                    </select>
                    <input type="text" id="post-search" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜..." class="form-input text-sm py-1 px-2 border rounded w-64 h-9">
                </div>
            </div>
            
            <div class="batch-actions hidden" id="batch-actions-toolbar">
              <span class="selected-count mr-2 text-sm text-gray-600">å·²é€‰ 0</span>
              <button class="action-btn delete-btn text-xs px-2 batch-btn" data-action="delete">åˆ é™¤</button>
              <button class="action-btn publish-btn text-xs px-2 batch-btn" data-action="publish">å‘å¸ƒ</button>
              <button class="action-btn unpublish-btn text-xs px-2 batch-btn" data-action="unpublish">å–æ¶ˆå‘å¸ƒ</button>
            </div>
        </div>
      </div>

      <div class="table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th class="w-10 text-center">
                <input type="checkbox" id="select-all-posts" class="cursor-pointer align-middle">
              </th>
              <th>æ ‡é¢˜</th>
              <th>çŠ¶æ€</th>
              <th>åˆ†ç±»</th>
              <th>å‘å¸ƒæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="posts-list">
            {blogPosts.map(post => (
              <tr key={post.id} class="post-row" data-title={post.data.title.toLowerCase()} data-status={post.data.status || 'draft'}>
                <td class="text-center">
                  <input type="checkbox" class="post-checkbox cursor-pointer align-middle" data-id={post.id}>
                </td>
                <td class="font-medium">{post.data.title}</td>
                <td>
                  <span class={`status-badge ${post.data.status === 'published' ? 'published' : 'draft'}`}>
                    {post.data.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}
                  </span>
                </td>
                <td>{post.data.categories ? post.data.categories.join(', ') : ''}</td>
                <td class="text-gray-500 text-sm">{post.data.publishedAt ? new Date(post.data.publishedAt).toLocaleDateString() : '-'}</td>
                <td class="admin-table-actions">
                  <button class="action-btn edit-btn flex items-center gap-1" data-type="post" data-id={post.id.replace(/\.md$/, '')} title="ç¼–è¾‘">
                    âœï¸ ç¼–è¾‘
                  </button>
                  <button class="action-btn view-btn flex items-center gap-1" data-type="post" data-slug={post.slug || post.id.replace(/\.md$/, '')} title="æŸ¥çœ‹">
                    ğŸ‘ æŸ¥çœ‹
                  </button>
                  {post.data.status === 'published' ? (
                    <button class="action-btn unpublish-btn flex items-center gap-1" data-action="unpublish" data-id={post.id} title="ä¸‹æ¶">
                      â†“ ä¸‹æ¶
                    </button>
                  ) : (
                    <button class="action-btn publish-btn flex items-center gap-1" data-action="publish" data-id={post.id} title="å‘å¸ƒ">
                      â†‘ å‘å¸ƒ
                    </button>
                  )}
                  <button class="action-btn delete-btn flex items-center gap-1" data-action="delete" data-id={post.id} title="åˆ é™¤">
                    Ã— åˆ é™¤
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        <!-- åˆ†é¡µæ§ä»¶ -->
        <div class="pagination-controls flex justify-between items-center">
          <div class="text-sm text-gray-500">
              æ˜¾ç¤º {startIdx + 1}-{Math.min(endIdx, totalPosts)} å…± {totalPosts} ç¯‡
          </div>
          <div class="flex gap-2 items-center">
              <a href={`?page=${Math.max(1, currentPage - 1)}`} class={`action-btn edit-btn no-underline ${currentPage === 1 ? 'opacity-50 pointer-events-none' : ''}`}>ä¸Šä¸€é¡µ</a>
              
              <div class="flex items-center gap-1">
                  {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                      let p = i + 1;
                      if (totalPages > 5) {
                          if (currentPage > 3) p = currentPage - 2 + i;
                          if (p > totalPages) p = totalPages - (4 - i);
                      }
                      if (p > totalPages || p < 1) return null;
                      
                      return (
                          <a href={`?page=${p}`} class={`px-3 py-1 rounded text-sm no-underline ${currentPage === p ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 border hover:bg-gray-50'}`}>
                              {p}
                          </a>
                      );
                  }).filter(Boolean)}
              </div>
  
              <a href={`?page=${Math.min(totalPages, currentPage + 1)}`} class={`action-btn edit-btn no-underline ${currentPage === totalPages ? 'opacity-50 pointer-events-none' : ''}`}>ä¸‹ä¸€é¡µ</a>
              
              <div class="flex items-center ml-4 gap-2">
                  <input type="number" id="jump-page-input" min="1" max={totalPages} class="w-16 px-2 py-1 border rounded text-sm h-8" placeholder="é¡µç ">
                  <button onclick="const p = document.getElementById('jump-page-input').value; if(p) window.location.href=`?page=${p}`" class="action-btn view-btn py-1 h-8">è·³è½¬</button>
              </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åŠ¨æ€ç®¡ç†æ ‡ç­¾é¡µ (ç®€åŒ–å±•ç¤ºï¼Œåç»­å¯åº”ç”¨åŒæ ·æ ·å¼) -->
    <div class="tab-content" id="notes-tab">
      <div class="admin-controls">
        <button class="admin-btn" onclick="createNote()">æ–°å»ºåŠ¨æ€</button>
      </div>
      <div class="table-container">
        <table class="admin-table">
            <thead><tr><th>æ ‡é¢˜</th><th>å¿ƒæƒ…</th><th>åœ°ç‚¹</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
            {notes.map(note => (
                <tr>
                <td>{note.data.title}</td>
                <td>{note.data.mood || ''}</td>
                <td>{note.data.location || ''}</td>
                <td>{note.data.createdAt ? new Date(note.data.createdAt).toLocaleDateString() : ''}</td>
                <td class="admin-table-actions">
                    <button class="action-btn edit-btn" data-type="note" data-id={note.id}>ç¼–è¾‘</button>
                </td>
                </tr>
            ))}
            </tbody>
        </table>
      </div>
    </div>

    <!-- å…¶ä»–æ ‡ç­¾é¡µä¿æŒåŸºæœ¬ç»“æ„ -->
    <div class="tab-content" id="pages-tab">
        <div class="table-container">
            <table class="admin-table">
                <thead><tr><th>æ ‡é¢˜</th><th>è·¯å¾„</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                {pages.map(p => (<tr><td>{p.data.title}</td><td>/{p.slug}</td>
                <td class="admin-table-actions"><button class="action-btn edit-btn" data-type="page" data-id={p.id}>ç¼–è¾‘</button></td></tr>))}
                </tbody>
            </table>
        </div>
    </div>
    <div class="tab-content" id="categories-tab">
        <div class="table-container">
            <table class="admin-table">
                <thead><tr><th>åç§°</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                {categories.map(c => (<tr><td>{c.data.title}</td>
                <td class="admin-table-actions"><button class="action-btn edit-btn" data-type="category" data-id={c.id}>ç¼–è¾‘</button></td></tr>))}
                </tbody>
            </table>
        </div>
    </div>
    <div class="tab-content" id="tags-tab">
        <div class="table-container">
            <table class="admin-table">
                <thead><tr><th>åç§°</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                {tags.map(t => (<tr><td>{t.data.title}</td>
                <td class="admin-table-actions"><button class="action-btn edit-btn" data-type="tag" data-id={t.id}>ç¼–è¾‘</button></td></tr>))}
                </tbody>
            </table>
        </div>
    </div>
  </div>

  <script>
    // æ‰¹é‡æ“ä½œé€»è¾‘
    const selectAllCheckbox = document.getElementById('select-all-posts');
    const postCheckboxes = document.querySelectorAll('.post-checkbox');
    const batchActionsToolbar = document.getElementById('batch-actions-toolbar');
    const selectedCountSpan = document.querySelector('.selected-count');
    const statusFilter = document.getElementById('status-filter');
    const postSearch = document.getElementById('post-search');
    
    // æ›´æ–°æ‰¹é‡æ“ä½œUIçŠ¶æ€
    function updateBatchUI() {
      const selectedboxes = document.querySelectorAll('.post-checkbox:checked');
      const count = selectedboxes.length;
      
      if (count > 0) {
        batchActionsToolbar.classList.remove('hidden');
        batchActionsToolbar.style.display = 'flex';
        selectedCountSpan.textContent = `å·²é€‰æ‹© ${count} é¡¹`;
      } else {
        batchActionsToolbar.classList.add('hidden');
        batchActionsToolbar.style.display = 'none';
      }
    }

    // å…¨é€‰/åé€‰
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        postCheckboxes.forEach(cb => cb.checked = isChecked);
        updateBatchUI();
      });
    }

    // å•ä¸ªå¤é€‰æ¡†å˜æ›´
    postCheckboxes.forEach(cb => {
      cb.addEventListener('change', updateBatchUI);
    });

    // ç­›é€‰å’Œæœç´¢é€»è¾‘
    function filterPosts() {
        const status = statusFilter.value;
        const searchText = postSearch.value.toLowerCase().trim();
        const rows = document.querySelectorAll('.post-row');
        
        rows.forEach(row => {
            const rowStatus = row.dataset.status;
            const rowTitle = row.dataset.title; // å·²ç»æ˜¯å°å†™äº†
            
            let statusMatch = (status === 'all') || (status === 'published' && rowStatus === 'published') || (status === 'draft' && rowStatus !== 'published');
            let searchMatch = rowTitle.includes(searchText);
            
            if (statusMatch && searchMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    if (statusFilter) {
        statusFilter.addEventListener('change', filterPosts);
    }

    if (postSearch) {
        postSearch.addEventListener('input', filterPosts);
    }

    // æ‰§è¡ŒAPIæ“ä½œ
    async function performAction(action, ids) {
       const actionMap = {
        'delete': 'åˆ é™¤',
        'publish': 'å‘å¸ƒ',
        'unpublish': 'å–æ¶ˆå‘å¸ƒ'
      };
      
      const actionName = actionMap[action] || action;
      
      if (!confirm(`ç¡®å®šè¦å¯¹ ${ids.length} ç¯‡æ–‡ç« æ‰§è¡Œ "${actionName}" æ“ä½œå—ï¼Ÿ${action === 'delete' ? 'æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚' : ''}`)) {
        return;
      }

      try {
        const response = await fetch('/api/content/blog/batch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: action,
            ids: ids
          })
        });

        const result = await response.json();

        if (result.success) {
          window.showToast(result.message, 'success');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          window.showToast('æ“ä½œå¤±è´¥: ' + (result.error || JSON.stringify(result.errors)), 'error');
        }
      } catch (error) {
        console.error('æ“ä½œå‡ºé”™:', error);
        window.showToast('æ“ä½œå‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
      }
    }

    // ç»‘å®šæ‰¹é‡æ“ä½œæŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.batch-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        const selectedIds = Array.from(document.querySelectorAll('.post-checkbox:checked'))
          .map(cb => cb.dataset.id);
        
        if (selectedIds.length === 0) return;
        performAction(action, selectedIds);
      });
    });

    // ç»‘å®šå•è¡Œæ“ä½œæŒ‰é’®äº‹ä»¶ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
    const postsList = document.querySelector('#posts-list');
    if (postsList) {
        postsList.addEventListener('click', (e) => {
            const btn = e.target.closest('.action-btn');
            if (!btn) return;
            
            // å¤„ç†ç¼–è¾‘
            if (btn.classList.contains('edit-btn')) {
                const id = btn.dataset.id;
                // ç§»é™¤ .md æ‰©å±•åï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const cleanId = id.replace(/\.md$/, '');
                window.location.href = `/admin/article-editor?edit=${encodeURIComponent(cleanId)}`;
                return;
            }
            
            // å¤„ç†æŸ¥çœ‹
            if (btn.classList.contains('view-btn')) {
                const slug = btn.dataset.slug;
                window.open(`/blog/${slug}`, '_blank');
                return;
            }

            // å¤„ç†å…¶ä»–åŠ¨ä½œ
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            if (action && id) {
                performAction(action, [id]);
            }
        });
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    document.querySelectorAll('.tab-btn').forEach(button => {
      button.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰activeç±»
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®å’Œå†…å®¹
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab') + '-tab';
        document.getElementById(tabId).classList.add('active');
      });
    });
  </script>

  <style>
    /* ç°ä»£åŒ– UI é‡æ„ */
    :root {
        --primary-color: #3498db;
        --border-color: #e2e8f0;
        --bg-hover: #f8fafc;
    }

    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 1.5rem;
    }

    /* Tabs ä¼˜åŒ– */
    .admin-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1px;
    }

    .tab-btn {
        background: none;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        color: #64748b;
        font-weight: 500;
        font-size: 0.95rem;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .tab-btn:hover {
        color: var(--primary-color);
        background-color: rgba(52, 152, 219, 0.05);
        border-radius: 6px 6px 0 0;
    }

    .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    /* é¡¶éƒ¨æ“ä½œæ  */
    .admin-controls {
        background: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
    }

    /* è¡¨æ ¼å®¹å™¨ */
    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
    }

    .admin-table thead {
        background-color: #f8fafc;
        border-bottom: 1px solid var(--border-color);
    }

    .admin-table th {
        padding: 16px;
        font-weight: 600;
        color: #475569;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .admin-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        color: #334155;
        font-size: 0.95rem;
        vertical-align: middle;
    }

    .admin-table tr:last-child td {
        border-bottom: none;
    }

    .admin-table tr:hover {
        background-color: #f1f5f9;
    }

    /* çŠ¶æ€å¾½ç«  */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1;
    }

    .status-badge.published {
        background-color: #dcfce7;
        color: #166534;
    }

    .status-badge.draft {
        background-color: #fef9c3;
        color: #854d0e;
    }

    /* æ“ä½œæŒ‰é’® */
    .admin-table-actions {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.2s;
        text-decoration: none;
    }

    .edit-btn {
        background-color: white;
        border-color: #cbd5e1;
        color: #334155;
    }
    .edit-btn:hover { border-color: #94a3b8; background-color: #f8fafc; }

    .view-btn {
        background-color: white;
        border-color: #cbd5e1;
        color: #0ea5e9;
    }
    .view-btn:hover { background-color: #e0f2fe; border-color: #7dd3fc; }

    .publish-btn {
        background-color: #dcfce7;
        color: #15803d;
    }
    .publish-btn:hover { background-color: #bbf7d0; }

    .unpublish-btn {
        background-color: #fef9c3;
        color: #a16207;
    }
    .unpublish-btn:hover { background-color: #fef08a; }

    .delete-btn {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    .delete-btn:hover { background-color: #fecaca; }

    /* é€šç”¨å·¥å…·ç±» */
    .w-64 { width: 16rem; }
    .text-sm { font-size: 0.875rem; }
    .text-gray-600 { color: #475569; }
    .text-gray-500 { color: #64748b; }
    .border { border: 1px solid var(--border-color); }
    .rounded { border-radius: 6px; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-4 { gap: 1rem; }
    .mr-2 { margin-right: 0.5rem; }
    .hidden { display: none; }
    .mt-4 { margin-top: 1rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    
    .cursor-pointer { cursor: pointer; }
    
    .form-select, .form-input {
        background-color: white;
        border: 1px solid #cbd5e1;
        transition: border-color 0.2s;
    }
    .form-select:focus, .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }
    
    /* åˆ†é¡µæ¡æ ·å¼ */
    .pagination-controls {
        padding: 16px;
        border-top: 1px solid var(--border-color);
        background-color: white;
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .batch-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 10px;
      border-radius: 4px;
      background-color: #f1f5f9;
    }
  </style>
</Layout>