---
import Layout from '../../../layouts/AdminLayout.astro';
import { getCollection } from 'astro:content';

// 获取所有内容类型的数据
const blogPosts = await getCollection('blog');
const pages = await getCollection('pages');
const categories = await getCollection('categories');
const tags = await getCollection('tags');
const notes = await getCollection('notes');
---

<Layout title="内容管理">
  <div class="admin-container">
    <h2>内容管理</h2>

    <div class="admin-tabs">
      <button class="tab-btn active" data-tab="posts">文章</button>
      <button class="tab-btn" data-tab="notes">动态</button>
      <button class="tab-btn" data-tab="pages">页面</button>
      <button class="tab-btn" data-tab="categories">分类</button>
      <button class="tab-btn" data-tab="tags">标签</button>
    </div>

    <!-- 文章管理标签页 -->
    <div class="tab-content active" id="posts-tab">
      <div class="admin-controls flex flex-col gap-4">
        <div class="flex justify-between items-center w-full">
            <div class="flex items-center gap-4">
                <a href="/admin/article-editor" class="admin-btn">新建文章</a>
                <!-- 筛选和搜索 -->
                <div class="flex items-center gap-2">
                    <select id="status-filter" class="form-select text-sm py-1 px-2 border rounded">
                        <option value="all">所有状态</option>
                        <option value="published">已发布</option>
                        <option value="draft">草稿/未发布</option>
                    </select>
                    <input type="text" id="post-search" placeholder="搜索文章标题..." class="form-input text-sm py-1 px-2 border rounded w-64">
                </div>
            </div>
            
            <div class="batch-actions hidden" id="batch-actions-toolbar">
              <span class="selected-count mr-2 text-sm text-gray-600">已选 0</span>
              <button class="admin-btn admin-btn-danger batch-btn text-xs px-2" data-action="delete">删除</button>
              <button class="admin-btn admin-btn-success batch-btn text-xs px-2" data-action="publish">发布</button>
              <button class="admin-btn admin-btn-warning batch-btn text-xs px-2" data-action="unpublish">取消发布</button>
            </div>
        </div>
      </div>

      <table class="admin-table">
        <thead>
          <tr>
            <th class="w-10 text-center">
              <input type="checkbox" id="select-all-posts" class="cursor-pointer align-middle">
            </th>
            <th>标题</th>
            <th>状态</th>
            <th>分类</th>
            <th>发布时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="posts-list">
          {blogPosts.map(post => (
            <tr key={post.id} class="post-row" data-title={post.data.title.toLowerCase()} data-status={post.data.status || 'draft'}>
              <td class="text-center">
                <input type="checkbox" class="post-checkbox cursor-pointer align-middle" data-id={post.id}>
              </td>
              <td>{post.data.title}</td>
              <td>
                <span class={`status-badge ${post.data.status || 'draft'}`}>
                  {post.data.status || 'draft'}
                </span>
              </td>
              <td>{post.data.categories ? post.data.categories.join(', ') : ''}</td>
              <td>{post.data.publishedAt ? new Date(post.data.publishedAt).toLocaleDateString() : '未发布'}</td>
              <td class="admin-table-actions">
                <button class="admin-btn admin-btn-secondary edit-btn" data-type="post" data-id={post.id.replace(/\.md$/, '')}>编辑</button>
                <button class="admin-btn view-btn" data-type="post" data-slug={post.slug || post.id.replace(/\.md$/, '')}>查看</button>
                {post.data.status === 'published' ? (
                  <button class="admin-btn admin-btn-warning action-btn" data-action="unpublish" data-id={post.id}>取消发布</button>
                ) : (
                  <button class="admin-btn admin-btn-success action-btn" data-action="publish" data-id={post.id}>发布</button>
                )}
                <button class="admin-btn admin-btn-danger action-btn" data-action="delete" data-id={post.id}>删除</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- 动态管理标签页 -->
    <div class="tab-content" id="notes-tab">
      <div class="admin-controls">
        <button class="admin-btn" onclick="createNote()">新建动态</button>
      </div>

      <table class="admin-table">
        <thead>
          <tr>
            <th>标题</th>
            <th>心情</th>
            <th>地点</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="notes-list">
          {notes.map(note => (
            <tr key={note.id}>
              <td>{note.data.title}</td>
              <td>{note.data.mood || ''}</td>
              <td>{note.data.location || ''}</td>
              <td>{note.data.createdAt ? new Date(note.data.createdAt).toLocaleDateString() : (note.data.updatedAt ? new Date(note.data.updatedAt).toLocaleDateString() : '')}</td>
              <td class="admin-table-actions">
                <button class="admin-btn admin-btn-secondary edit-btn" data-type="note" data-id={note.id}>编辑</button>
                <button class="admin-btn view-btn" data-type="note" data-slug={note.slug}>查看</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- 页面管理标签页 -->
    <div class="tab-content" id="pages-tab">
      <div class="admin-controls">
        <button class="admin-btn" onclick="createPage()">新建页面</button>
      </div>

      <table class="admin-table">
        <thead>
          <tr>
            <th>页面名称</th>
            <th>路径</th>
            <th>状态</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="pages-list">
          {pages.map(page => (
            <tr key={page.id}>
              <td>{page.data.title}</td>
              <td>/{page.slug}</td>
              <td>
                <span class={`status-badge ${page.data.status || 'draft'}`}>
                  {page.data.status || 'draft'}
                </span>
              </td>
              <td>{page.data.createdAt ? new Date(page.data.createdAt).toLocaleDateString() : (page.data.updatedAt ? new Date(page.data.updatedAt).toLocaleDateString() : '')}</td>
              <td class="admin-table-actions">
                <button class="admin-btn admin-btn-secondary edit-btn" data-type="page" data-id={page.id}>编辑</button>
                <button class="admin-btn view-btn" data-type="page" data-slug={page.slug}>查看</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- 分类管理标签页 -->
    <div class="tab-content" id="categories-tab">
      <div class="admin-controls">
        <button class="admin-btn" onclick="createCategory()">新建分类</button>
      </div>

      <table class="admin-table">
        <thead>
          <tr>
            <th>分类名称</th>
            <th>颜色</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="categories-list">
          {categories.map(category => (
            <tr key={category.id}>
              <td>{category.data.title}</td>
              <td>{category.data.color || ''}</td>
              <td>{category.data.createdAt ? new Date(category.data.createdAt).toLocaleDateString() : (category.data.updatedAt ? new Date(category.data.updatedAt).toLocaleDateString() : '')}</td>
              <td class="admin-table-actions">
                <button class="admin-btn admin-btn-secondary edit-btn" data-type="category" data-id={category.id}>编辑</button>
                <button class="admin-btn view-btn" data-type="category" data-slug={category.slug}>查看</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- 标签管理标签页 -->
    <div class="tab-content" id="tags-tab">
      <div class="admin-controls">
        <button class="admin-btn" onclick="createTag()">新建标签</button>
      </div>

      <table class="admin-table">
        <thead>
          <tr>
            <th>标签名称</th>
            <th>颜色</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="tags-list">
          {tags.map(tag => (
            <tr key={tag.id}>
              <td>{tag.data.title}</td>
              <td>{tag.data.color || ''}</td>
              <td>{tag.data.createdAt ? new Date(tag.data.createdAt).toLocaleDateString() : (tag.data.updatedAt ? new Date(tag.data.updatedAt).toLocaleDateString() : '')}</td>
              <td class="admin-table-actions">
                <button class="admin-btn admin-btn-secondary edit-btn" data-type="tag" data-id={tag.id}>编辑</button>
                <button class="admin-btn view-btn" data-type="tag" data-slug={tag.slug}>查看</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // 批量操作逻辑
    const selectAllCheckbox = document.getElementById('select-all-posts');
    const postCheckboxes = document.querySelectorAll('.post-checkbox');
    const batchActionsToolbar = document.getElementById('batch-actions-toolbar');
    const selectedCountSpan = document.querySelector('.selected-count');
    const statusFilter = document.getElementById('status-filter');
    const postSearch = document.getElementById('post-search');
    
    // 筛选和搜索逻辑
    function filterPosts() {
        const status = statusFilter.value;
        const searchText = postSearch.value.toLowerCase().trim();
        const rows = document.querySelectorAll('.post-row');
        
        rows.forEach(row => {
            const rowStatus = row.dataset.status;
            const rowTitle = row.dataset.title; // 已经是小写了
            
            let statusMatch = (status === 'all') || (status === 'published' && rowStatus === 'published') || (status === 'draft' && rowStatus !== 'published');
            let searchMatch = rowTitle.includes(searchText);
            
            if (statusMatch && searchMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    if (statusFilter) {
        statusFilter.addEventListener('change', filterPosts);
    }

    if (postSearch) {
        postSearch.addEventListener('input', filterPosts);
    }
    
    // 更新批量操作UI状态
    function updateBatchUI() {
      const selectedboxes = document.querySelectorAll('.post-checkbox:checked');
      const count = selectedboxes.length;
      
      if (count > 0) {
        batchActionsToolbar.classList.remove('hidden');
        batchActionsToolbar.style.display = 'flex';
        selectedCountSpan.textContent = `已选择 ${count} 项`;
      } else {
        batchActionsToolbar.classList.add('hidden');
        batchActionsToolbar.style.display = 'none';
      }
    }

    // 全选/反选
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        postCheckboxes.forEach(cb => cb.checked = isChecked);
        updateBatchUI();
      });
    }

    // 单个复选框变更
    postCheckboxes.forEach(cb => {
      cb.addEventListener('change', updateBatchUI);
    });

    // 执行API操作
    async function performAction(action, ids) {
       const actionMap = {
        'delete': '删除',
        'publish': '发布',
        'unpublish': '取消发布'
      };
      
      const actionName = actionMap[action] || action;
      
      if (!confirm(`确定要对 ${ids.length} 篇文章执行 "${actionName}" 操作吗？${action === 'delete' ? '此操作不可撤销。' : ''}`)) {
        return;
      }

      try {
        const response = await fetch('/api/content/blog/batch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: action,
            ids: ids
          })
        });

        const result = await response.json();

        if (result.success) {
          alert(result.message);
          window.location.reload();
        } else {
          alert('操作失败: ' + (result.error || JSON.stringify(result.errors)));
        }
      } catch (error) {
        console.error('操作出错:', error);
        alert('操作出错，请查看控制台');
      }
    }

    // 绑定批量操作按钮事件
    document.querySelectorAll('.batch-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        const selectedIds = Array.from(document.querySelectorAll('.post-checkbox:checked'))
          .map(cb => cb.dataset.id);
        
        if (selectedIds.length === 0) return;
        performAction(action, selectedIds);
      });
    });

    // 绑定单行操作按钮事件 (使用事件委托)
    document.querySelector('#posts-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('action-btn')) {
        const action = e.target.dataset.action;
        const id = e.target.dataset.id;
        if (action && id) {
          performAction(action, [id]);
        }
      }
    });

    // 切换标签页
    document.querySelectorAll('.tab-btn').forEach(button => {
      button.addEventListener('click', () => {
        // 移除所有active类
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // 添加active类到当前按钮和内容
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab') + '-tab';
        document.getElementById(tabId).classList.add('active');
      });
    });

    // 通用函数占位符
    function createPost() {
      window.location.href = '/admin/article-editor';
    }

    // 使用事件委托处理按钮点击
    document.addEventListener('click', function(e) {
      // 处理编辑按钮
      if (e.target.classList.contains('edit-btn')) {
        const type = e.target.dataset.type;
        const id = e.target.dataset.id;

        switch(type) {
          case 'post':
            // 移除 .md 扩展名（如果存在）
            const cleanId = id.replace(/\.md$/, '');
            // 跳转到新的文章编辑器，并传递文章ID
            window.location.href = `/admin/article-editor?edit=${encodeURIComponent(cleanId)}`;
            break;
          case 'note':
            alert('编辑动态: ' + id);
            break;
          case 'page':
            alert('编辑页面: ' + id);
            break;
          case 'category':
            alert('编辑分类: ' + id);
            break;
          case 'tag':
            alert('编辑标签: ' + id);
            break;
        }
      }

      // 处理查看按钮
      if (e.target.classList.contains('view-btn')) {
        const type = e.target.dataset.type;
        const slug = e.target.dataset.slug;

        switch(type) {
          case 'post':
            window.open(`/blog/${slug}`, '_blank');
            break;
          case 'note':
            window.open(`/notes/${slug}`, '_blank');
            break;
          case 'page':
            window.open(`/${slug}`, '_blank');
            break;
          case 'category':
            window.open(`/categories/${slug}`, '_blank');
            break;
          case 'tag':
            window.open(`/tags/${slug}`, '_blank');
            break;
        }
      }
    });
  </script>

  <style>
    .batch-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 10px;
      border-radius: 4px;
    }
    
    .batch-actions.hidden {
      display: none;
    }

    .selected-count {
      font-weight: 500;
      color: #495057;
      margin-right: 5px;
    }

    .admin-btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .admin-btn-danger:hover {
      background-color: #c82333;
    }

    .admin-btn-success {
      background-color: #28a745;
      color: white;
    }
    
    .admin-btn-success:hover {
      background-color: #218838;
    }
    
    .admin-btn-warning {
      background-color: #ffc107;
      color: #212529;
    }
    
    .admin-btn-warning:hover {
      background-color: #e0a800;
    }

    .flex {
      display: flex;
    }
    
    .items-center {
      align-items: center;
    }
    
    .gap-4 {
      gap: 1rem;
    }
    
    .mr-2 {
      margin-right: 0.5rem;
    }

    .w-10 {
      width: 2.5rem;
    }
    
    .text-center {
      text-align: center;
    }
    
    .cursor-pointer {
      cursor: pointer;
    }
    
    .align-middle {
      vertical-align: middle;
    }

    .w-64 {
      width: 16rem;
    }

    .form-select, .form-input {
      background-color: white;
      border: 1px solid #ced4da;
    }
    
    .text-sm {
      font-size: 0.875rem;
    }
    
    .text-xs {
      font-size: 0.75rem;
    }
    
    .text-gray-600 {
      color: #718096;
    }
    
    .py-1 {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }
    
    .px-2 {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    
    .rounded {
      border-radius: 0.25rem;
    }
    
    .flex-col {
      flex-direction: column;
    }
    
    .w-full {
      width: 100%;
    }
    
    .gap-2 {
      gap: 0.5rem;
    }

    .admin-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }

    .tab-btn.active {
      border-bottom: 3px solid #3498db;
      color: #3498db;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .admin-controls {
      margin-bottom: 20px;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .status-badge.published {
      background: #d4edda;
      color: #155724;
    }

    .status-badge.draft {
      background: #fff3cd;
      color: #856404;
    }

    .status-badge.archived {
      background: #f8d7da;
      color: #721c24;
    }

    .admin-table-actions {
      display: flex;
      gap: 5px;
    }

    .admin-table-actions .admin-btn {
      padding: 4px 8px;
      font-size: 12px;
      margin: 0;
    }
  </style>
</Layout>