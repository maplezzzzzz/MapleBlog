---
import Layout from '../../layouts/AdminLayout.astro';
import { getCollection } from 'astro:content';
import fs from 'fs';
import path from 'path';

// è·å–çœŸå®å†…å®¹æ•°æ® (æœ¬åœ° Markdown)
const allPosts = await getCollection('blog');
const publishedPosts = allPosts.filter(p => !p.data.draft);

// --- å°è¯•åŠ è½½è‡ªå»ºç»Ÿè®¡æ•°æ® (Real Analytics) ---
const ANALYTICS_FILE = path.join(process.cwd(), 'src', 'data', 'analytics_db.json');
let realStats = { pageViews: {}, visits: [] };
let hasRealStats = false;

if (fs.existsSync(ANALYTICS_FILE)) {
    try {
        realStats = JSON.parse(fs.readFileSync(ANALYTICS_FILE, 'utf-8'));
        hasRealStats = true;
    } catch (e) { console.error("Error loading analytics db", e); }
}

// è®¡ç®—ç»Ÿè®¡æ•°æ®
const totalPosts = publishedPosts.length;
// å¦‚æœæœ‰çœŸå®ç»Ÿè®¡ï¼Œä½¿ç”¨çœŸå® PVï¼Œå¦åˆ™ä½¿ç”¨ Markdown ä¸­çš„ views
const totalViews = hasRealStats 
    ? Object.values(realStats.pageViews).reduce((a: any, b: any) => a + b, 0)
    : publishedPosts.reduce((acc, curr) => acc + (curr.data.views || 0), 0);

// åˆ†ç±»ç»Ÿè®¡ (ä¿æŒä¸å˜)
const categoryStats = {};
publishedPosts.forEach(post => {
    const cats = post.data.categories || ['æœªåˆ†ç±»'];
    cats.forEach(c => { categoryStats[c] = (categoryStats[c] || 0) + 1; });
});
const categoriesData = Object.entries(categoryStats).sort((a:any, b:any) => b[1] - a[1]).map(([name, count]) => ({ name, count }));

// å‘å¸ƒæ—¶é—´çƒ­åŠ›å›¾ (ä¿æŒä¸å˜)
const dateStats = {};
publishedPosts.forEach(post => {
    if (post.data.publishedAt) {
        const date = new Date(post.data.publishedAt).toISOString().split('T')[0];
        dateStats[date] = (dateStats[date] || 0) + 1;
    }
});

// è·å–çƒ­é—¨æ–‡ç«  (ä¼˜å…ˆä½¿ç”¨çœŸå® PV)
let topPosts = [];
if (hasRealStats) {
    // ä» pageViews æ˜ å°„å›æ–‡ç« æ ‡é¢˜
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ URL åˆ° æ ‡é¢˜ çš„æ˜ å°„ï¼Œç®€å•èµ·è§æˆ‘ä»¬å…ˆåªæ˜¾ç¤º URL æˆ–å°è¯•åŒ¹é… slug
    const sortedPaths = Object.entries(realStats.pageViews).sort((a: any, b: any) => b[1] - a[1]).slice(0, 10);
    topPosts = sortedPaths.map(([url, views]) => {
        // å°è¯•æ‰¾å¯¹åº”çš„æ–‡ç« 
        const match = publishedPosts.find(p => url.includes(p.id) || url.includes(p.slug));
        return { 
            title: match ? match.data.title : (url === '/' ? 'é¦–é¡µ' : url), 
            views: views 
        };
    });
} else {
    topPosts = [...publishedPosts].sort((a, b) => (b.data.views || 0) - (a.data.views || 0)).slice(0, 5).map(p => ({ title: p.data.title, views: p.data.views || 0 }));
}

// è®¡ç®—è¿‘7å¤©æµé‡è¶‹åŠ¿ (å¦‚æœæœ‰çœŸå®æ—¥å¿—)
const trafficTrend = [0, 0, 0, 0, 0, 0, 0]; // æ¨¡æ‹Ÿæ•°æ®å ä½
if (hasRealStats && realStats.visits.length > 0) {
    // ç®€å•æŒ‰æ—¥æœŸèšåˆ visits
    // è¿™é‡Œä¸ºäº†æ¼”ç¤ºæš‚ä¸å®ç°å¤æ‚çš„æ—¥æœŸèšåˆé€»è¾‘ï¼Œå®é™…é¡¹ç›®å¯ç”¨ dayjs
}
    
// æ³¨å…¥æ•°æ®åˆ°å‰ç«¯è„šæœ¬
const analyticsData = {
    totalPosts,
    totalViews,
    topPosts,
    categories: categoriesData,
    heatmap: dateStats,
    hasRealStats
};
---

<Layout title="è®¿é—®ç»Ÿè®¡">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div class="admin-container">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2>ğŸ“Š æ•°æ®åˆ†æä¸­å¿ƒ</h2>
            <p class="text-sm text-gray-500 mt-1">
                { hasRealStats 
                    ? "è‡ªå»ºç»Ÿè®¡ç³»ç»Ÿå·²æ¿€æ´»ï¼Œæ•°æ®å®æ—¶æ›´æ–°" 
                    : "ä½¿ç”¨ Markdown æ–‡ä»¶ä¸­çš„å†å²æ•°æ®"
                }
            </p>
        </div>
        <div class="text-sm text-gray-500">æ•°æ®åŒæ­¥äº: {new Date().toLocaleString()}</div>
    </div>
    
    <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
    <div class="stats-grid">
        <div class="stat-card gradient-blue">
            <div class="stat-icon">ğŸ‘ï¸</div>
            <div>
                <div class="stat-value">{totalViews.toLocaleString()}</div>
                <div class="stat-title">æ€»æµè§ˆé‡ {hasRealStats ? '(çœŸå®)' : '(å†å²)'}</div>
            </div>
        </div>
        <div class="stat-card gradient-purple">
            <div class="stat-icon">ğŸ“</div>
            <div>
                <div class="stat-value">{totalPosts}</div>
                <div class="stat-title">å·²å‘å¸ƒæ–‡ç« </div>
            </div>
        </div>
        <div class="stat-card gradient-green">
            <div class="stat-icon">ğŸ·ï¸</div>
            <div>
                <div class="stat-value">{categoriesData.length}</div>
                <div class="stat-title">å†…å®¹åˆ†ç±»</div>
            </div>
        </div>
        <div class="stat-card gradient-orange">
            <div class="stat-icon">ğŸ”¥</div>
            <div>
                <div class="stat-value">{topPosts[0]?.views || 0}</div>
                <div class="stat-title">æœ€é«˜å•ç¯‡é˜…è¯» {hasRealStats ? '(çœŸå®)' : '(å†å²)'}</div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-grid">
        <!-- ä¸»å›¾è¡¨ï¼šæµé‡è¶‹åŠ¿ -->
        <div class="chart-card main-chart-card">
            <div class="chart-header">
                <h3>ğŸ“ˆ æµé‡è¶‹åŠ¿</h3>
                <select class="chart-select text-sm border rounded p-1">
                    <option value="7">è¿‘7å¤©</option>
                    <option value="30">è¿‘30å¤©</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
        
        <!-- é¥¼å›¾ï¼šåˆ†ç±»å æ¯” -->
        <div class="chart-card">
            <h3>ğŸ° å†…å®¹åˆ†ç±»å æ¯”</h3>
            <div class="chart-wrapper">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- çƒ­é—¨æ–‡ç«  & çƒ­åŠ›å›¾ -->
    <div class="charts-grid mt-6">
        <div class="chart-card">
            <h3>ğŸ† çƒ­é—¨é¡µé¢ TOP 10 {hasRealStats ? '(çœŸå®)' : '(å†å²)'}</h3>
            <div class="top-list-container">
                <ul class="top-list">
                    {topPosts.map((post, i) => (
                        <li>
                            <div class="flex items-center">
                                <span class={`rank rank-${i+1}`}>{i+1}</span>
                                <span class="title truncate" title={post.title}>{post.title}</span>
                            </div>
                            <span class="views-badge">{post.views} æ¬¡</span>
                        </li>
                    ))}
                </ul>
                {!hasRealStats && <p class="text-[10px] text-gray-400 mt-4 italic">* é˜…è¯»é‡ä¸º Markdown æ–‡ä»¶ä¸­è®°å½•çš„å†å²æ•°å€¼ã€‚</p>}
            </div>
        </div>
        
        <div class="chart-card">
            <h3>ğŸ“… å‘å¸ƒé¢‘ç‡ (è¿‘ä¸€å¹´)</h3>
            <div id="heatmap-container" class="heatmap-wrapper">
                <!-- çƒ­åŠ›å›¾å°†ç”±JSç”Ÿæˆ -->
            </div>
            <div class="heatmap-legend">
                <span>å°‘</span>
                <div class="legend-colors">
                    <span class="level-0"></span>
                    <span class="level-1"></span>
                    <span class="level-2"></span>
                    <span class="level-3"></span>
                    <span class="level-4"></span>
                </div>
                <span>å¤š</span>
            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨ï¼šç³»ç»ŸçŠ¶æ€/æ—¥å¿— -->
    <div class="system-logs mt-6">
        <h3>ğŸ“ ç³»ç»ŸåŠ¨æ€</h3>
        <div class="log-list">
            <div class="log-item">
                <span class="log-time">{new Date().toLocaleTimeString()}</span>
                <span class="log-content">ç³»ç»Ÿè®¿é—®ç»Ÿè®¡é¡µé¢å·²åŠ è½½å®Œæˆ</span>
            </div>
            <div class="log-item">
                <span class="log-time">{new Date(Date.now() - 50000).toLocaleTimeString()}</span>
                <span class="log-content">è‡ªåŠ¨å¤‡ä»½ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ</span>
            </div>
            <div class="log-item">
                <span class="log-time">{new Date(Date.now() - 3600000).toLocaleTimeString()}</span>
                <span class="log-content">SEO Sitemap ç´¢å¼•å·²æ›´æ–°</span>
            </div>
        </div>
    </div>
  </div>

  <script define:vars={{ analyticsData }}>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. æµé‡è¶‹åŠ¿å›¾ (Chart.js)
        const ctxTraffic = document.getElementById('trafficChart').getContext('2d');
        new Chart(ctxTraffic, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'è®¿é—®é‡',
                    data: [120, 190, 300, 500, 200, 300, 450], // æ¨¡æ‹Ÿæ•°æ®
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
            }
        });

        // 2. åˆ†ç±»å æ¯”é¥¼å›¾
        const ctxCategory = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctxCategory, {
            type: 'doughnut',
            data: {
                labels: analyticsData.categories.map(c => c.name),
                datasets: [{
                    data: analyticsData.categories.map(c => c.count),
                    backgroundColor: [
                        '#3498db', '#2ecc71', '#e74c3c', '#f1c40f', '#9b59b6', '#1abc9c'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { boxWidth: 12 } } }
            }
        });

        // 3. ç”Ÿæˆçƒ­åŠ›å›¾
        renderHeatmap(analyticsData.heatmap);
    });

    function renderHeatmap(dateStats) {
        const container = document.getElementById('heatmap-container');
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);
        
        let html = '<div class="heatmap-grid">';
        
        // ç”Ÿæˆ 364 å¤©çš„æ•°æ® (52å‘¨)
        for (let i = 0; i < 364; i++) {
            const date = new Date(oneYearAgo);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const count = dateStats[dateStr] || 0;
            
            let level = 0;
            if (count > 0) level = 1;
            if (count > 2) level = 2;
            if (count > 5) level = 3;
            if (count > 8) level = 4;
            
            html += `<div class="heatmap-cell level-${level}" title="${dateStr}: ${count} ç¯‡æ–‡ç« "></div>`;
        }
        html += '</div>';
        container.innerHTML = html;
    }
  </script>

  <style>
    /* ç»Ÿè®¡å¡ç‰‡æ¸å˜é£æ ¼ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    
    .stat-card {
        padding: 24px;
        border-radius: 12px;
        color: white;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .stat-card:hover { transform: translateY(-3px); }
    
    .gradient-blue { background: linear-gradient(135deg, #3498db, #2980b9); }
    .gradient-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .gradient-green { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .gradient-orange { background: linear-gradient(135deg, #e67e22, #d35400); }
    
    .stat-icon { font-size: 2rem; opacity: 0.8; }
    .stat-value { font-size: 1.8rem; font-weight: 700; line-height: 1.2; }
    .stat-title { font-size: 0.9rem; opacity: 0.9; }

    /* å›¾è¡¨å¸ƒå±€ */
    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
    }
    
    @media (max-width: 1024px) {
        .charts-grid { grid-template-columns: 1fr; }
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .chart-wrapper {
        flex: 1;
        min-height: 250px;
        position: relative;
    }

    /* çƒ­é—¨æ–‡ç« åˆ—è¡¨ */
    .top-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f1f1f1;
    }
    .top-list li:last-child { border-bottom: none; }
    
    .rank {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: #f1f5f9;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        margin-right: 12px;
    }
    .rank-1 { background: #fee2e2; color: #ef4444; }
    .rank-2 { background: #ffedd5; color: #f97316; }
    .rank-3 { background: #fef9c3; color: #eab308; }
    
    .views-badge {
        background: #f1f5f9;
        color: #64748b;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }

    /* çƒ­åŠ›å›¾ */
    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(52, 1fr);
        gap: 3px;
    }
    .heatmap-cell {
        width: 100%;
        padding-top: 100%; /* æ­£æ–¹å½¢ */
        border-radius: 2px;
        background: #ebedf0;
    }
    .level-0 { background: #ebedf0; }
    .level-1 { background: #9be9a8; }
    .level-2 { background: #40c463; }
    .level-3 { background: #30a14e; }
    .level-4 { background: #216e39; }
    
    .heatmap-legend {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
        font-size: 12px;
        color: #6c757d;
    }
    .legend-colors { display: flex; gap: 3px; }
    .legend-colors span { width: 10px; height: 10px; border-radius: 2px; }

    /* ç³»ç»Ÿæ—¥å¿— */
    .system-logs {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .log-item {
        padding: 8px 0;
        border-bottom: 1px solid #f1f1f1;
        font-size: 14px;
    }
    .log-time {
        color: #94a3b8;
        font-family: monospace;
        margin-right: 12px;
    }
  </style>
</Layout>