---
import Layout from '../../layouts/AdminLayout.astro';
import fs from 'fs';
import path from 'path';

const ADS_FILE = path.join(process.cwd(), "src", "data", "ads.json");
let initialAds = [];

if (fs.existsSync(ADS_FILE)) {
    try {
        initialAds = JSON.parse(fs.readFileSync(ADS_FILE, "utf-8"));
    } catch (e) {
        console.error("Error reading ads file:", e);
    }
}
---

<Layout title="å¹¿å‘Šç®¡ç†">
  <div class="admin-container">
    <div class="flex justify-between items-center mb-6">
        <h2>ğŸ“¢ å¹¿å‘Šç®¡ç†</h2>
        <button class="admin-btn" onclick="addNewAd()">+ æ–°å¢å¹¿å‘Šä½</button>
    </div>
    
    <div id="ads-container">
        <!-- å¹¿å‘Šåˆ—è¡¨å°†ç”±JSæ¸²æŸ“ï¼Œæˆ–ç›´æ¥SSRæ¸²æŸ“åˆå§‹çŠ¶æ€ -->
        {initialAds.length === 0 ? (
            <div class="empty-state">æš‚æ— å¹¿å‘Šä½ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ ã€‚</div>
        ) : (
            <div class="ads-grid">
                {initialAds.map((ad, index) => (
                    <div class="ad-card" data-id={ad.id}>
                        <div class="ad-header">
                            <span class="ad-name">{ad.name}</span>
                            <span class={`status-badge ${ad.active ? 'published' : 'archived'}`}>
                                {ad.active ? 'å¯ç”¨' : 'ç¦ç”¨'}
                            </span>
                        </div>
                        <div class="ad-body">
                            <div class="form-group">
                                <label>ç±»å‹</label>
                                <select class="form-select ad-type" onchange="updateAdField(this, 'type')">
                                    <option value="image" selected={ad.type === 'image'}>å›¾ç‰‡é“¾æ¥</option>
                                    <option value="html" selected={ad.type === 'html'}>HTML ä»£ç  / Google Ads</option>
                                    <option value="text" selected={ad.type === 'text'}>çº¯æ–‡æœ¬</option>
                                </select>
                            </div>
                             <div class="form-group">
                                <label>{ad.type === 'html' ? 'HTML / Script ä»£ç ' : 'å†…å®¹ / å›¾ç‰‡URL'}</label>
                                <div class="flex gap-2">
                                    {ad.type === 'html' ? (
                                        <textarea class="form-input ad-content" rows="4" onchange="updateAdField(this, 'content')" placeholder="åœ¨æ­¤ç²˜è´´ Google AdSense æˆ–å…¶ä»–å¹¿å‘Šä»£ç ...">{ad.content}</textarea>
                                    ) : (
                                        <input type="text" class="form-input ad-content" value={ad.content} onchange="updateAdField(this, 'content')" placeholder="è¾“å…¥URLæˆ–ä¸Šä¼ å›¾ç‰‡">
                                    )}
                                    
                                    {ad.type === 'image' && (
                                        <label class="admin-btn admin-btn-secondary cursor-pointer whitespace-nowrap" style="padding: 6px 12px; height: 38px;">
                                            ä¸Šä¼ 
                                            <input type="file" class="hidden" accept="image/*" onchange="uploadAdImage(this)">
                                        </label>
                                    )}
                                </div>
                                {ad.type === 'image' && ad.content && (
                                    <div class="mt-2 p-2 border rounded bg-gray-50 text-center">
                                        <img src={ad.content} alt="é¢„è§ˆ" style="max-height: 100px; max-width: 100%; object-fit: contain;" onerror="this.style.display='none'">
                                    </div>
                                )}
                            </div>
                             {ad.type !== 'html' && (
                                <div class="form-group">
                                    <label>è·³è½¬é“¾æ¥</label>
                                    <input type="text" class="form-input ad-link" value={ad.link} onchange="updateAdField(this, 'link')">
                                </div>
                             )}
                        </div>
                        <div class="ad-footer">
                            <button class="text-red-500 text-sm" onclick={`deleteAd('${index}')`}>åˆ é™¤</button>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" checked={ad.active} onchange="updateAdField(this, 'active')"> å¯ç”¨
                            </label>
                        </div>
                    </div>
                ))}
            </div>
        )}
    </div>
    
    <div class="sticky-bottom">
        <button class="admin-btn admin-btn-primary" id="save-ads-btn">ä¿å­˜æ‰€æœ‰æ›´æ”¹</button>
    </div>
  </div>

  <script define:vars={{ initialAds }}>
    let ads = initialAds;

    window.addNewAd = () => {
        const newAd = {
            id: 'ad-' + Date.now(),
            name: 'æ–°å¹¿å‘Šä½',
            type: 'image',
            content: '',
            link: '',
            active: true
        };
        ads.push(newAd);
        renderAds();
    };

    window.deleteAd = (index) => {
        if(confirm('ç¡®å®šåˆ é™¤æ­¤å¹¿å‘Šä½å—ï¼Ÿ')) {
            ads.splice(index, 1);
            renderAds();
        }
    };

    window.uploadAdImage = async (input) => {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const formData = new FormData();
        formData.append('image', file);
        
        const btn = input.parentElement;
        const originalText = btn.childNodes[0].nodeValue; // Get text node "ä¸Šä¼ "
        
        try {
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            // å‡è®¾æˆ‘ä»¬å¤ç”¨ä¹‹å‰æåˆ°çš„ enhanced-admin-api-server çš„ä¸Šä¼ æ¥å£
            // æˆ–è€…æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Astro API ç«¯ç‚¹
            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„ä¸Šä¼ è·¯å¾„ï¼Œé€šå¸¸æ˜¯ /api/upload/image (å¦‚æœ express æœåŠ¡åœ¨è¿è¡Œ)
            // æˆ–è€…æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ª Astro ç‰ˆæœ¬çš„ä¸Šä¼  API
            
            // ä¸ºäº†ç¡®ä¿ç¨³å¥æ€§ï¼Œæˆ‘å»ºè®®å…ˆå°è¯•è°ƒç”¨ Astro API (å¦‚æœæˆ‘è¿˜æ²¡åˆ›å»ºï¼Œç¨åä¼šåˆ›å»º)
            // è®©æˆ‘ä»¬å…ˆå‡è®¾æœ‰ä¸€ä¸ª /api/upload ç«¯ç‚¹
            
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok && result.url) {
                // æ‰¾åˆ°å¯¹åº”çš„æ–‡æœ¬è¾“å…¥æ¡†
                const textInput = input.parentElement.previousElementSibling;
                textInput.value = result.url;
                // è§¦å‘ change äº‹ä»¶ä»¥æ›´æ–°æ•°æ®æ¨¡å‹
                updateAdField(textInput, 'content');
                
                // åˆ·æ–°é¢„è§ˆå›¾ (é‡æ–°æ¸²æŸ“ä¼šå¤„ç†ï¼Œæˆ–è€…æ‰‹åŠ¨æ›´æ–° DOM)
                const previewContainer = input.closest('.form-group').querySelector('img');
                if (previewContainer) {
                    previewContainer.src = result.url;
                    previewContainer.style.display = 'block';
                } else {
                    // å¦‚æœè¿˜æ²¡æœ‰é¢„è§ˆå›¾ï¼Œåˆ·æ–°é¡µé¢æˆ–é‡æ–°æ¸²æŸ“
                    renderAds(); 
                }
                window.showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
            } else {
                window.showToast('ä¸Šä¼ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } catch (e) {
            console.error(e);
            window.showToast('ä¸Šä¼ å‡ºé”™ï¼Œè¯·ç¡®ä¿åå°ä¸Šä¼ æœåŠ¡æ­£å¸¸è¿è¡Œ', 'error');
        } finally {
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            input.value = ''; // Reset input
        }
    };

    window.updateAdField = (el, field) => {
        const card = el.closest('.ad-card');
        const index = Array.from(card.parentElement.children).indexOf(card);
        
        if (field === 'active') {
            ads[index][field] = el.checked;
            // æ›´æ–°çŠ¶æ€å¾½ç« 
            const badge = card.querySelector('.status-badge');
            badge.className = `status-badge ${el.checked ? 'published' : 'archived'}`;
            badge.textContent = el.checked ? 'å¯ç”¨' : 'ç¦ç”¨';
        } else {
            ads[index][field] = el.value;
        }
    };

    function renderAds() {
        // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œç›´æ¥åˆ·æ–°é¡µé¢æˆ–ä½¿ç”¨ç®€å•çš„DOMæ“ä½œä¼šæ›´å¥½
        // ä½†ç”±äºä½¿ç”¨äº† Astroï¼Œæˆ‘ä»¬å°½é‡åˆ©ç”¨ stateã€‚
        // ç”±äºè¿™é‡Œæ˜¯çº¯å®¢æˆ·ç«¯é€»è¾‘æ›´æ–°æ•°æ®ç„¶åç»Ÿä¸€ä¿å­˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°ç”ŸæˆHTMLå­—ç¬¦ä¸²
        // æˆ–è€…æ›´ç®€å•ï¼šä¿å­˜ååˆ·æ–°ã€‚
        
        // ä¸ºäº†ä½“éªŒï¼Œæˆ‘ä»¬ç®€å•å®ç°ä¸€ä¸ªåŸºäºå½“å‰æ•°æ®çš„ä¿å­˜é€»è¾‘
        saveAds(false); // ä¿å­˜ä½†ä¸å¼¹çª—ï¼Œç„¶ååˆ·æ–°
        window.location.reload();
    }

    async function saveAds(showMsg = true) {
        const btn = document.getElementById('save-ads-btn');
        try {
            if(btn) {
                btn.disabled = true;
                btn.textContent = 'ä¿å­˜ä¸­...';
            }
            
            const response = await fetch('/api/ads', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ads)
            });
            
            if (response.ok) {
                if(showMsg) window.showToast('å¹¿å‘Šè®¾ç½®å·²ä¿å­˜', 'success');
            } else {
                window.showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        } catch(e) {
            console.error(e);
            window.showToast('ä¿å­˜å‡ºé”™', 'error');
        } finally {
            if(btn) {
                btn.disabled = false;
                btn.textContent = 'ä¿å­˜æ‰€æœ‰æ›´æ”¹';
            }
        }
    }
    
    document.getElementById('save-ads-btn')?.addEventListener('click', () => saveAds(true));
  </script>

  <style>
    .ads-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding-bottom: 80px;
    }
    
    .ad-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
        border: 1px solid #eee;
    }
    
    .ad-header {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .ad-name {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .ad-body {
        padding: 15px;
    }
    
    .ad-footer {
        padding: 10px 15px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .form-group {
        margin-bottom: 10px;
    }
    
    .form-group label {
        display: block;
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 4px;
    }
    
    .form-input, .form-select {
        width: 100%;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 13px;
    }
    
    .text-red-500 { color: #dc3545; }
    .text-sm { font-size: 12px; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .mb-6 { margin-bottom: 1.5rem; }
    .gap-2 { gap: 0.5rem; }
    
    .status-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .status-badge.published { background: #d4edda; color: #155724; }
    .status-badge.archived { background: #f8d7da; color: #721c24; }

    .sticky-bottom {
        position: fixed;
        bottom: 20px;
        right: 40px;
        z-index: 100;
    }
    
    .admin-btn-primary {
        background-color: #3498db;
        color: white;
        padding: 10px 24px;
        box-shadow: 0 4px 6px rgba(52,152,219,0.3);
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        background: white;
        border-radius: 8px;
    }
  </style>
</Layout>