--- 
import Layout from '../../layouts/AdminLayout.astro';
import fs from 'fs';
import path from 'path';

// åˆå§‹åŠ è½½ settings è·å– SEO ä¿¡æ¯
const SETTINGS_FILE = path.join(process.cwd(), "src", "data", "settings.json");
let settings = { seo: { keywords: "", googleVerification: "", baiduVerification: "" } };

if (fs.existsSync(SETTINGS_FILE)) {
    try {
        const data = JSON.parse(fs.readFileSync(SETTINGS_FILE, "utf-8"));
        if (!data.seo) data.seo = { keywords: "", googleVerification: "", baiduVerification: "" };
        settings = data;
    } catch (e) { console.error(e); }
}

// åˆå§‹åŠ è½½ robots.txt
const ROBOTS_FILE = path.join(process.cwd(), "public", "robots.txt");
let robotsContent = "User-agent: *\nAllow: /";
if (fs.existsSync(ROBOTS_FILE)) {
    robotsContent = fs.readFileSync(ROBOTS_FILE, "utf-8");
}
---

<Layout title="SEO ä¼˜åŒ–">
  <div class="admin-container">
    <h2>ğŸ” SEO ä¼˜åŒ–</h2>
    
    <div class="grid-container">
        <!-- åŸºç¡€ SEO è®¾ç½® -->
        <div class="admin-card">
            <h3>åŸºç¡€å…ƒæ•°æ®</h3>
            <form id="seo-meta-form">
                <div class="form-group">
                    <label>å…³é”®è¯ (Keywords)</label>
                    <textarea name="seo.keywords" class="form-input" rows="3" placeholder="åšå®¢, æŠ€æœ¯, ç”Ÿæ´», åˆ†äº« (ç”¨é€—å·åˆ†éš”)">{settings.seo.keywords}</textarea>
                    <p class="text-hint">è¿™äº›å…³é”®è¯å°†å‡ºç°åœ¨ç½‘ç«™é¦–é¡µçš„ meta keywords æ ‡ç­¾ä¸­ã€‚</p>
                </div>
                <div class="form-group">
                    <label>Google ç«™ç‚¹éªŒè¯ä»£ç </label>
                    <input type="text" name="seo.googleVerification" class="form-input" value={settings.seo.googleVerification} placeholder="google-site-verification=...">
                </div>
                <div class="form-group">
                    <label>ç™¾åº¦ç«™ç‚¹éªŒè¯ä»£ç </label>
                    <input type="text" name="seo.baiduVerification" class="form-input" value={settings.seo.baiduVerification}>
                </div>
                <button type="submit" class="admin-btn admin-btn-primary">ä¿å­˜å…ƒæ•°æ®</button>
            </form>
        </div>

        <!-- Robots.txt ç¼–è¾‘ -->
        <div class="admin-card">
            <h3>robots.txt ç¼–è¾‘</h3>
            <div class="form-group">
                <textarea id="robots-content" class="form-input code-editor" rows="10">{robotsContent}</textarea>
            </div>
            <button id="save-robots-btn" class="admin-btn">ä¿å­˜ robots.txt</button>
        </div>
        
        <!-- ç«™ç‚¹åœ°å›¾ -->
        <div class="admin-card">
            <h3>ç«™ç‚¹åœ°å›¾ (Sitemap)</h3>
            <p>ç«™ç‚¹åœ°å›¾ä¼šè‡ªåŠ¨ç”Ÿæˆåœ¨ <code>/sitemap.xml</code>ã€‚</p>
            <div class="mt-4">
                <a href="/sitemap.xml" target="_blank" class="admin-btn admin-btn-secondary">æŸ¥çœ‹ç«™ç‚¹åœ°å›¾</a>
                <button class="admin-btn ml-2" onclick="window.showToast('ç«™ç‚¹åœ°å›¾æ˜¯å®æ—¶åŠ¨æ€ç”Ÿæˆçš„ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°ã€‚', 'info')">åˆ·æ–°ç”Ÿæˆ</button>
            </div>
        </div>
    </div>
  </div>

  <script>
    // ä¿å­˜ SEO Meta
    document.getElementById('seo-meta-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.textContent;
        
        try {
            btn.disabled = true;
            btn.textContent = 'ä¿å­˜ä¸­...';
            
            // å…ˆè·å–ç°æœ‰è®¾ç½®
            const settingsRes = await fetch('/api/settings');
            const currentSettings = await settingsRes.json();
            
            const formData = new FormData(e.target);
            
            // æ›´æ–° SEO éƒ¨åˆ†
            currentSettings.seo = {
                keywords: formData.get('seo.keywords'),
                googleVerification: formData.get('seo.googleVerification'),
                baiduVerification: formData.get('seo.baiduVerification')
            };
            
            // ä¿å­˜å›æœåŠ¡å™¨
            const saveRes = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentSettings)
            });
            
            if (saveRes.ok) {
                window.showToast('SEO å…ƒæ•°æ®å·²ä¿å­˜', 'success');
            } else {
                throw new Error('ä¿å­˜å¤±è´¥');
            }
        } catch (err) {
            window.showToast('ä¿å­˜å‡ºé”™: ' + err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });

    // ä¿å­˜ Robots.txt
    document.getElementById('save-robots-btn').addEventListener('click', async (e) => {
        const btn = e.target;
        const content = document.getElementById('robots-content').value;
        const originalText = btn.textContent;

        try {
            btn.disabled = true;
            btn.textContent = 'ä¿å­˜ä¸­...';
            
            const res = await fetch('/api/seo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            
            if (res.ok) {
                window.showToast('robots.txt å·²æ›´æ–°', 'success');
            } else {
                window.showToast('æ›´æ–°å¤±è´¥', 'error');
            }
        } catch (err) {
            window.showToast('å‡ºé”™: ' + err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });
  </script>

  <style>
    .grid-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    @media (min-width: 768px) {
        .grid-container {
            grid-template-columns: 1fr 1fr;
        }
    }

    .admin-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .admin-card h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #2c3e50;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
    }
    
    .form-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    
    .code-editor {
        font-family: monospace;
        background-color: #f8f9fa;
        font-size: 13px;
    }

    .text-hint {
        font-size: 12px;
        color: #6c757d;
        margin-top: 4px;
    }
    
    .mt-4 { margin-top: 1rem; }
    .ml-2 { margin-left: 0.5rem; }
    
    .admin-btn-primary {
        background-color: #3498db;
        color: white;
    }
  </style>
</Layout>
